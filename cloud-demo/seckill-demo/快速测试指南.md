# 秒杀系统 快速测试指南

## 一、环境准备（10分钟）

### 1. 启动MySQL
```bash
# 进入MySQL
mysql -uroot -p

# 执行初始化脚本
source D:/code/cloud-demo/cloud-demo/seckill-demo/init.sql

# 验证数据
USE cloud_seckill;
SHOW TABLES;
SELECT * FROM tb_seckill_product;
```

### 2. 启动Redis
```bash
# 启动Redis服务
redis-server

# 验证Redis
redis-cli
ping
# 应该返回：PONG
```

### 3. 启动RocketMQ
```bash
# 第1步：启动NameServer（新开CMD窗口）
cd D:\rocketmq\bin
start mqnamesrv.cmd

# 第2步：启动Broker（新开CMD窗口）
cd D:\rocketmq\bin
start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true

# 验证启动成功
jps -l
# 应该看到：
# NamesrvStartup
# BrokerStartup
```

---

## 二、启动服务（2分钟）

### 方式1：IDEA启动（推荐）
```
1. 打开IDEA，导入cloud-demo项目
2. 找到SeckillServiceApplication，右键Run（8092端口）
3. 找到ConsumerApplication，右键Run（8093端口）
```

### 方式2：Maven启动
```bash
# 启动秒杀服务（新开CMD窗口）
cd D:\code\cloud-demo\cloud-demo\seckill-demo\seckill-service
mvn spring-boot:run

# 启动消费者（新开CMD窗口）
cd D:\code\cloud-demo\cloud-demo\seckill-demo\seckill-consumer
mvn spring-boot:run
```

### 验证启动成功
```
秒杀服务控制台应该显示：
========================================
秒杀服务启动成功！端口：8092
========================================

消费者控制台应该显示：
========================================
秒杀消费者启动成功！端口：8093
========================================
```

---

## 三、快速测试（5分钟）

### 测试1：预热库存 ⭐
```bash
# 预热商品1的库存到Redis
curl -X POST http://localhost:8092/seckill/preload/1

# 预期结果：
# {"success":true,"message":"库存预热成功","data":null}

# 验证Redis库存
redis-cli
GET seckill:stock:1
# 应该返回：10000
```

### 测试2：秒杀成功 ⭐⭐⭐
```bash
# 用户1001秒杀商品1
curl -X POST http://localhost:8092/seckill/kill ^
-H "Content-Type: application/json" ^
-d "{\"userId\":1001,\"productId\":1,\"quantity\":1}"

# 预期结果：
# 1. 秒杀服务返回：{"success":true,"message":"秒杀成功，请等待支付","data":"SK..."}
# 2. 秒杀服务控制台打印：
#    ========== 秒杀请求 ==========
#    用户ID：1001，商品ID：1，数量：1
#    Redis扣减库存结果：9999
#    秒杀成功，发送MQ消息
#    秒杀成功，订单号：SK...
# 3. 消费者控制台打印：
#    ========== 秒杀订单消费 ==========
#    收到秒杀消息：用户ID=1001, 商品ID=1, 数量=1
#    MySQL库存扣减成功：商品ID=1, 数量=1
#    订单创建成功：订单号=SK...
```

### 测试3：验证数据
```bash
# 1. 验证Redis库存
redis-cli
GET seckill:stock:1
# 应该返回：9999（扣减了1）

# 2. 验证MySQL库存
mysql -uroot -p
USE cloud_seckill;
SELECT stock FROM tb_seckill_product WHERE id = 1;
# 应该返回：9999

# 3. 验证订单
SELECT * FROM tb_seckill_order ORDER BY id DESC LIMIT 1;
# 应该看到用户1001的订单

# 4. 验证库存日志
SELECT * FROM tb_stock_log ORDER BY id DESC LIMIT 1;
# 应该看到库存扣减记录

# 5. 验证用户秒杀记录
SELECT * FROM tb_user_seckill WHERE user_id = 1001 AND product_id = 1;
# 应该看到用户1001秒杀商品1的记录
```

### 测试4：重复秒杀（应该失败）
```bash
# 用户1001再次秒杀商品1
curl -X POST http://localhost:8092/seckill/kill ^
-H "Content-Type: application/json" ^
-d "{\"userId\":1001,\"productId\":1,\"quantity\":1}"

# 预期结果：
# {"success":false,"message":"秒杀失败，库存不足或已秒杀","data":null}

# 秒杀服务控制台打印：
# 用户1001已秒杀商品1，不能重复秒杀
```

### 测试5：库存不足（应该失败）
```bash
# 清空Redis库存
redis-cli
SET seckill:stock:1 0

# 用户1002秒杀商品1
curl -X POST http://localhost:8092/seckill/kill ^
-H "Content-Type: application/json" ^
-d "{\"userId\":1002,\"productId\":1,\"quantity\":1}"

# 预期结果：
# {"success":false,"message":"秒杀失败，库存不足或已秒杀","data":null}

# 秒杀服务控制台打印：
# 商品1库存不足
```

---

## 四、压力测试（可选）

### 使用JMeter压测
```bash
# 1. 下载JMeter
# 2. 创建测试计划
# 3. 添加HTTP请求：POST http://localhost:8092/seckill/kill
# 4. 设置并发数：10000
# 5. 设置持续时间：10秒
# 6. 运行测试

# 预期性能：
# - Redis QPS：100000+
# - 秒杀服务QPS：10000+
# - 响应时间：<10ms
# - 超卖：0
```

### 压测脚本（PowerShell）
```powershell
# 模拟1000个用户同时秒杀
for ($i=1; $i -le 1000; $i++) {
    Start-Job -ScriptBlock {
        param($userId)
        curl -X POST http://localhost:8092/seckill/kill `
        -H "Content-Type: application/json" `
        -d "{`"userId`":$userId,`"productId`":1,`"quantity`":1}"
    } -ArgumentList $i
}

# 等待所有任务完成
Get-Job | Wait-Job

# 查看结果
Get-Job | Receive-Job
```

---

## 五、验证结果

### 1. 查看Redis库存
```bash
redis-cli
GET seckill:stock:1
# 应该是：10000 - 秒杀成功数量
```

### 2. 查看MySQL库存
```sql
SELECT stock FROM tb_seckill_product WHERE id = 1;
-- 应该和Redis库存一致
```

### 3. 查看订单数量
```sql
SELECT COUNT(*) FROM tb_seckill_order WHERE product_id = 1;
-- 应该等于秒杀成功数量
```

### 4. 查看库存日志
```sql
SELECT COUNT(*) FROM tb_stock_log WHERE product_id = 1 AND type = 1;
-- 应该等于秒杀成功数量
```

### 5. 验证数据一致性
```sql
-- Redis库存 + 订单数量 = 初始库存
-- 10000 - Redis库存 = 订单数量
SELECT 
    (SELECT stock FROM tb_seckill_product WHERE id = 1) AS MySQL库存,
    (SELECT COUNT(*) FROM tb_seckill_order WHERE product_id = 1) AS 订单数量,
    10000 - (SELECT stock FROM tb_seckill_product WHERE id = 1) AS 已售数量;
```

---

## 六、常见问题排查

### 问题1：Redis连接失败
```
错误：Unable to connect to Redis

解决：
1. 检查Redis是否启动：redis-cli ping
2. 检查端口是否被占用：netstat -ano | findstr 6379
3. 重启Redis
```

### 问题2：RocketMQ连接失败
```
错误：connect to <127.0.0.1:9876> failed

解决：
1. 检查RocketMQ是否启动：jps -l
2. 检查端口是否被占用：netstat -ano | findstr 9876
3. 重启RocketMQ
```

### 问题3：数据库连接失败
```
错误：Access denied for user 'root'@'localhost'

解决：
1. 检查MySQL是否启动
2. 检查用户名密码是否正确（application.yml）
3. 检查数据库是否存在：SHOW DATABASES LIKE 'cloud_seckill';
```

### 问题4：Lua脚本执行失败
```
错误：ERR Error running script

解决：
1. 检查Lua脚本路径：src/main/resources/lua/stock.lua
2. 检查Redis版本（需要2.6+）
3. 重启秒杀服务
```

### 问题5：库存不一致
```
问题：Redis库存和MySQL库存不一致

解决：
1. 查看消费者日志，是否有消费失败
2. 查看库存日志表，是否有扣减记录
3. 重新预热库存
```

---

## 七、测试完成清单

- [ ] MySQL启动成功，数据初始化完成
- [ ] Redis启动成功，可以连接
- [ ] RocketMQ启动成功（NameServer + Broker）
- [ ] 秒杀服务启动成功（8092）
- [ ] 消费者启动成功（8093）
- [ ] 预热库存成功
- [ ] 秒杀成功测试通过
- [ ] 重复秒杀测试通过（应该失败）
- [ ] 库存不足测试通过（应该失败）
- [ ] 数据一致性验证通过
- [ ] Redis库存 = MySQL库存

---

## 八、下一步

测试通过后，可以：
1. 修改代码，添加更多功能（限流、防刷、监控）
2. 调整配置，优化性能
3. 集成到自己的项目中
4. 学习高级特性（分布式锁、库存回滚、定时同步）

---

**测试时间：约20分钟**  
**难度：⭐⭐⭐⭐（中高）**  
**推荐测试顺序：预热库存 → 秒杀成功 → 验证数据 → 重复秒杀 → 库存不足**
