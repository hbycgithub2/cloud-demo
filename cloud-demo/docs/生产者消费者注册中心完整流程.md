# 生产者、消费者、注册中心完整流程

## 三个角色

1. **生产者（Provider）** = UserService（提供用户信息）
2. **注册中心（Registry）** = Nacos（管理服务地址）
3. **消费者（Consumer）** = OrderService（调用用户服务）

---

## 一、生产者 UserService

### 1.1 怎么生产的

#### 代码位置
`user-service/src/main/java/cn/itcast/user/web/UserController.java`

```java
@RestController
@RequestMapping("/user")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    // 生产接口：根据 ID 查询用户
    @GetMapping("/{id}")
    public User queryById(@PathVariable("id") Long id) {
        return userService.queryById(id);  // ← 这就是"生产"
    }
}
```

**生产什么？** 
- 提供 HTTP 接口：`GET /user/{id}`
- 返回用户信息：`User{id, name, address}`

---

### 1.2 怎么注册的

#### 配置文件
`user-service/src/main/resources/bootstrap.yml`

```yaml
spring:
  application:
    name: userservice  # ← 服务名
  cloud:
    nacos:
      server-addr: localhost:8848  # ← Nacos 地址
      discovery:
        cluster-name: SH  # ← 集群名（上海）
```

#### 启动类
`user-service/src/main/java/cn/itcast/user/UserApplication.java`

```java
@SpringBootApplication
public class UserApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserApplication.class, args);
        // 启动时自动注册到 Nacos（不用写代码）
    }
}
```

#### 注册流程

```
1. UserService 启动（端口 8081）
   ↓
2. 读取配置：
   - 服务名：userservice
   - Nacos 地址：localhost:8848
   - 本机 IP：192.168.26.1（自动获取）
   - 集群名：SH
   ↓
3. 自动发送 HTTP 请求到 Nacos：
   POST http://localhost:8848/nacos/v1/ns/instance
   {
     "serviceName": "userservice",
     "ip": "192.168.26.1",
     "port": 8081,
     "clusterName": "SH",
     "healthy": true,
     "weight": 1.0
   }
   ↓
4. Nacos 保存服务信息：
   userservice → [192.168.26.1:8081]
   ↓
5. 启动心跳任务（每 5 秒发一次）：
   PUT http://localhost:8848/nacos/v1/ns/instance/beat
   告诉 Nacos："我还活着"
   ↓
6. 注册成功！
```

#### 关键依赖
`user-service/pom.xml`

```xml
<!-- Nacos 服务发现 -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

---

## 二、消费者 OrderService

### 2.1 怎么消费的

#### 定义 Feign 客户端
`feign-api/src/main/java/cn/itcast/feign/clients/UserClient.java`

```java
@FeignClient("userservice")  // ← 指定要调用的服务名
public interface UserClient {
    
    @GetMapping("/user/{id}")  // ← 要调用的接口路径
    User findById(@PathVariable("id") Long id);
}
```

#### 消费者使用
`order-service/src/main/java/cn/itcast/order/service/OrderService.java`

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private UserClient userClient;  // ← 注入 Feign 客户端
    
    public Order queryOrderById(Long orderId) {
        // 1. 查询订单
        Order order = orderMapper.findById(orderId);
        
        // 2. 调用 UserService（消费）
        User user = userClient.findById(order.getUserId());  // ← 这就是"消费"
        
        // 3. 封装返回
        order.setUser(user);
        return order;
    }
}
```

#### 控制器
`order-service/src/main/java/cn/itcast/order/web/OrderController.java`

```java
@RestController
@RequestMapping("order")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @GetMapping("{orderId}")
    public Order queryOrderByUserId(@PathVariable("orderId") Long orderId) {
        return orderService.queryOrderById(orderId);
    }
}
```

#### 消费流程

```
1. 用户访问：GET http://localhost:8080/order/101
   ↓
2. OrderController 接收请求
   ↓
3. OrderService.queryOrderById(101)
   ↓
4. 查询数据库：
   SELECT * FROM tb_order WHERE id = 101
   得到：order{id=101, price=100, userId=1}
   ↓
5. 调用 userClient.findById(1)
   ↓
6. Feign 拦截调用：
   - 服务名：userservice
   - 接口路径：/user/1
   ↓
7. 从本地缓存查询 userservice 的地址：
   serviceCache.get("userservice")
   得到：[192.168.26.1:8081, 192.168.26.2:8081]
   ↓
8. Ribbon 负载均衡选一个：
   192.168.26.1:8081（轮询算法）
   ↓
9. 拼接完整 URL：
   http://192.168.26.1:8081/user/1
   ↓
10. 发送 HTTP 请求到 UserService
   ↓
11. UserService 返回：
   User{id=1, name="张三", address="北京"}
   ↓
12. OrderService 封装：
   order.setUser(user)
   ↓
13. 返回给前端：
   {
     "id": 101,
     "price": 100,
     "user": {
       "id": 1,
       "name": "张三",
       "address": "北京"
     }
   }
```

---

### 2.2 怎么注册的

#### 配置文件
`order-service/src/main/resources/application.yml`

```yaml
server:
  port: 8080

spring:
  application:
    name: orderservice  # ← 服务名
  cloud:
    nacos:
      server-addr: localhost:8848  # ← Nacos 地址
      discovery:
        cluster-name: HZ  # ← 集群名（杭州）
```

#### 启动类
`order-service/src/main/java/cn/itcast/order/OrderApplication.java`

```java
@SpringBootApplication
@EnableFeignClients(clients = UserClient.class)  // ← 启用 Feign
public class OrderApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
        // 启动时：
        // 1. 自己注册到 Nacos
        // 2. 订阅 userservice 的地址
    }
}
```

#### 注册+订阅流程

```
1. OrderService 启动（端口 8080）
   ↓
2. 注册自己到 Nacos：
   POST http://localhost:8848/nacos/v1/ns/instance
   {
     "serviceName": "orderservice",
     "ip": "192.168.26.1",
     "port": 8080,
     "clusterName": "HZ"
   }
   ↓
3. Nacos 保存：
   orderservice → [192.168.26.1:8080]
   ↓
4. 发现 @FeignClient("userservice")
   ↓
5. 订阅 userservice 的地址：
   GET http://localhost:8848/nacos/v1/ns/instance/list?serviceName=userservice
   ↓
6. Nacos 返回：
   {
     "hosts": [
       {"ip": "192.168.26.1", "port": 8081, "healthy": true},
       {"ip": "192.168.26.2", "port": 8081, "healthy": true}
     ]
   }
   ↓
7. 存入本地缓存：
   serviceCache.put("userservice", [192.168.26.1:8081, 192.168.26.2:8081])
   ↓
8. 启动定时任务（每 10 秒更新缓存）
   ↓
9. 启动 UDP 监听（接收 Nacos 推送）
   ↓
10. 注册+订阅完成！
```

#### 关键依赖
`order-service/pom.xml`

```xml
<!-- Nacos 服务发现 -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<!-- Feign 客户端 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

---

## 三、注册中心 Nacos

### 3.1 Nacos 的作用

#### 1. 服务注册
```
接收服务的注册请求：
POST /nacos/v1/ns/instance
{
  "serviceName": "userservice",
  "ip": "192.168.26.1",
  "port": 8081
}

保存到内存：
Map<String, List<Instance>> registry = {
  "userservice": [
    {ip: "192.168.26.1", port: 8081, healthy: true}
  ],
  "orderservice": [
    {ip: "192.168.26.1", port: 8080, healthy: true}
  ]
}
```

#### 2. 服务发现
```
接收查询请求：
GET /nacos/v1/ns/instance/list?serviceName=userservice

返回服务列表：
{
  "hosts": [
    {"ip": "192.168.26.1", "port": 8081, "healthy": true},
    {"ip": "192.168.26.2", "port": 8081, "healthy": true}
  ]
}
```

#### 3. 健康检查
```
接收心跳：
PUT /nacos/v1/ns/instance/beat
{
  "serviceName": "userservice",
  "ip": "192.168.26.1",
  "port": 8081
}

检查逻辑：
- 5 秒没收到心跳 → 继续等待
- 15 秒没收到心跳 → 标记为不健康（healthy=false）
- 30 秒没收到心跳 → 从列表中删除
```

#### 4. 变化推送
```
服务上线/下线时：
1. 更新内存中的服务列表
2. 通过 UDP 推送给所有订阅者：
   "userservice 有变化，请更新缓存"
3. 订阅者收到推送后，立即查询最新列表
```

---

## 四、完整调用链路

### 场景：用户查询订单详情

```
┌─────────┐
│  前端   │
└────┬────┘
     │ GET http://localhost:8080/order/101
     ↓
┌─────────────────────────────────────────────────────────┐
│                   OrderService (8080)                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 1. OrderController 接收请求                       │  │
│  │    ↓                                              │  │
│  │ 2. OrderService.queryOrderById(101)              │  │
│  │    ↓                                              │  │
│  │ 3. 查询数据库：order{id=101, userId=1}           │  │
│  │    ↓                                              │  │
│  │ 4. userClient.findById(1)                        │  │
│  │    ↓                                              │  │
│  │ 5. Feign 拦截：服务名=userservice                │  │
│  │    ↓                                              │  │
│  │ 6. 查询本地缓存：[192.168.26.1:8081]            │  │
│  │    ↓                                              │  │
│  │ 7. Ribbon 负载均衡：选 192.168.26.1:8081        │  │
│  │    ↓                                              │  │
│  │ 8. 发送 HTTP 请求                                │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                       │
                       │ GET http://192.168.26.1:8081/user/1
                       ↓
┌─────────────────────────────────────────────────────────┐
│                   UserService (8081)                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 9. UserController.queryById(1)                   │  │
│  │    ↓                                              │  │
│  │ 10. UserService 查询数据库                       │  │
│  │    ↓                                              │  │
│  │ 11. 返回：User{id=1, name="张三"}               │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                       │
                       │ 返回用户信息
                       ↓
┌─────────────────────────────────────────────────────────┐
│                   OrderService (8080)                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 12. 封装：order.setUser(user)                    │  │
│  │    ↓                                              │  │
│  │ 13. 返回给前端                                    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                       │
                       ↓
┌─────────┐
│  前端   │ 收到：{id:101, price:100, user:{id:1, name:"张三"}}
└─────────┘
```

---

## 五、三者关系图

```
                    ┌─────────────────────────────────────┐
                    │        Nacos 注册中心 (8848)        │
                    │  ┌───────────────────────────────┐ │
                    │  │ 服务列表：                     │ │
                    │  │ userservice:                  │ │
                    │  │   - 192.168.26.1:8081 ✅      │ │
                    │  │   - 192.168.26.2:8081 ✅      │ │
                    │  │ orderservice:                 │ │
                    │  │   - 192.168.26.1:8080 ✅      │ │
                    │  └───────────────────────────────┘ │
                    └─────────────────────────────────────┘
                         ↑ 注册              ↑ 注册
                         │ 心跳              │ 心跳
                         │                   │
            ┌────────────┴────────┐    ┌────┴─────────────┐
            │                     │    │                  │
            │                     │    │                  │
    ┌───────┴────────┐    ┌──────┴────────┐    ┌────────┴────────┐
    │  UserService   │    │  UserService  │    │  OrderService   │
    │   (生产者)     │    │   (生产者)    │    │   (消费者)      │
    │  192.168.26.1  │    │ 192.168.26.2  │    │  192.168.26.1   │
    │     :8081      │    │    :8081      │    │     :8080       │
    └────────────────┘    └───────────────┘    └─────────────────┘
            ↑                     ↑                      │
            │                     │                      │
            │                     │                      │
            └─────────────────────┴──────────────────────┘
                        HTTP 调用（负载均衡）
                    GET http://192.168.26.x:8081/user/{id}
```

---

## 六、关键配置对比

### UserService（生产者）

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 服务名 | userservice | 在 Nacos 中的标识 |
| 端口 | 8081 | 服务监听端口 |
| Nacos 地址 | localhost:8848 | 注册中心地址 |
| 集群名 | SH | 上海集群 |
| 角色 | 生产者 | 提供接口 |

### OrderService（消费者）

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 服务名 | orderservice | 在 Nacos 中的标识 |
| 端口 | 8080 | 服务监听端口 |
| Nacos 地址 | localhost:8848 | 注册中心地址 |
| 集群名 | HZ | 杭州集群 |
| 角色 | 消费者 | 调用其他服务 |
| 调用的服务 | userservice | 通过 @FeignClient 指定 |

---

## 七、启动顺序

### 推荐启动顺序

```
1. 启动 Nacos
   startup.cmd -m standalone
   访问：http://localhost:8848/nacos
   
2. 启动 UserService（生产者）
   java -jar user-service.jar
   或在 IDEA 中运行 UserApplication
   
3. 启动 OrderService（消费者）
   java -jar order-service.jar
   或在 IDEA 中运行 OrderApplication
   
4. 测试调用
   GET http://localhost:8080/order/101
```

### 为什么这个顺序？

```
1. Nacos 必须先启动
   - 否则服务无法注册
   
2. UserService 建议先启动
   - OrderService 启动时会订阅 userservice
   - 如果 userservice 还没注册，缓存是空的
   - 但不影响，OrderService 会定时更新缓存
   
3. 实际上顺序不重要
   - 服务会自动重试注册
   - 缓存会自动更新
```

---

## 八、常见问题

### Q1: OrderService 调用 UserService 失败怎么办？

**检查清单：**
```
1. Nacos 是否启动？
   访问：http://localhost:8848/nacos
   
2. UserService 是否注册成功？
   在 Nacos 控制台查看服务列表
   
3. OrderService 是否订阅成功？
   查看 OrderService 日志：
   "subscribe userservice success"
   
4. 网络是否通？
   ping 192.168.26.1
   
5. 端口是否正确？
   UserService 监听 8081
```

### Q2: 如何验证服务注册成功？

**方法 1：Nacos 控制台**
```
1. 访问：http://localhost:8848/nacos
2. 用户名/密码：nacos/nacos
3. 进入"服务管理" → "服务列表"
4. 看到 userservice 和 orderservice
```

**方法 2：查看日志**
```
UserService 日志：
nacos registry, DEFAULT_GROUP userservice 192.168.26.1:8081 register finished

OrderService 日志：
nacos registry, DEFAULT_GROUP orderservice 192.168.26.1:8080 register finished
```

### Q3: 如何验证服务调用成功？

**测试接口：**
```bash
# 直接调用 UserService
curl http://localhost:8081/user/1

# 通过 OrderService 调用
curl http://localhost:8080/order/101
```

**查看日志：**
```
OrderService 日志：
Feign 调用：userservice /user/1
负载均衡选择：192.168.26.1:8081
调用成功，返回：User{id=1, name="张三"}
```

---

## 九、总结

### 生产者 UserService
- **生产**：提供 `GET /user/{id}` 接口
- **注册**：启动时自动注册到 Nacos（服务名：userservice，地址：192.168.26.1:8081）
- **心跳**：每 5 秒发送心跳，告诉 Nacos "我还活着"

### 消费者 OrderService
- **消费**：通过 `userClient.findById()` 调用 UserService
- **注册**：启动时自动注册到 Nacos（服务名：orderservice，地址：192.168.26.1:8080）
- **订阅**：启动时自动订阅 userservice 的地址，存入本地缓存
- **更新**：每 10 秒更新缓存，或收到 Nacos 推送时立即更新

### 注册中心 Nacos
- **管理**：保存所有服务的地址
- **提供**：给消费者查询生产者的地址
- **监控**：通过心跳检测服务是否存活
- **推送**：服务变化时主动通知订阅者

### 核心流程

```
1. 生产者启动 → 注册到 Nacos
2. 消费者启动 → 注册到 Nacos + 订阅生产者
3. 用户请求 → 消费者查缓存 → 负载均衡 → 调用生产者
4. 生产者返回 → 消费者封装 → 返回给用户
```

**关键：生产者和消费者都不知道对方的 IP，都通过 Nacos 来找！**
