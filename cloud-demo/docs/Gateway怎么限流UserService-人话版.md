# Gateway 怎么限流 UserService - 人话版

## 一、人话版（一句话）

**Gateway 限流 UserService 就像数数：**
- Gateway 有一个计数器（记录请求数）
- 每来一个 /user/** 的请求，计数器 +1
- 如果计数器 > 10，就拒绝
- 每秒计数器清零，重新开始数

---

## 二、Gateway 怎么知道要限流 UserService？

### 答案：看请求路径

```
Gateway 收到请求：
  - GET /user/1 → 这是 UserService 的请求 ✅
  - GET /order/1 → 这是 OrderService 的请求 ❌
  - GET /product/1 → 这是 ProductService 的请求 ❌

Gateway 想：
  - 路径是 /user/** 开头的，就是 UserService 的请求
  - 我要限流 UserService，所以要检查这个请求
```

**人话：**
- Gateway 看请求路径
- 路径是 /user/** 开头的，就知道是 UserService 的请求
- 就像看门牌号，知道你要去哪栋楼

---

## 三、完整流程图（超级详细）

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：Gateway 收到请求                                       │
│                                                                 │
│  请求：GET /user/1                                               │
│                                                                 │
│  Gateway 想：这个请求要转发到哪里？                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：Gateway 检查请求路径                                   │
│                                                                 │
│  请求路径：/user/1                                               │
│                                                                 │
│  Gateway 想：                                                    │
│    这个路径是 /user/ 开头的                                      │
│    说明是 UserService 的请求                                     │
│    我要限流 UserService                                          │
│    所以要检查这个请求                                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：Gateway 查看计数器                                     │
│                                                                 │
│  Gateway 有一个计数器（Map）：                                   │
│    key: "user:10:00:00"  ← 服务名 + 当前秒                      │
│    value: 5              ← 当前秒已有 5 个请求                  │
│                                                                 │
│  Gateway 想：                                                    │
│    当前时间：10:00:00                                            │
│    key = "user:10:00:00"                                        │
│    当前秒已有 5 个请求                                           │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：Gateway 计数器 +1                                      │
│                                                                 │
│  计数器：                                                        │
│    key: "user:10:00:00"                                         │
│    value: 5 + 1 = 6      ← 计数器 +1                           │
│                                                                 │
│  Gateway 想：                                                    │
│    现在有 6 个请求了                                             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 5 步：Gateway 检查是否超过限制                               │
│                                                                 │
│  限流规则：每秒最多 10 个请求                                    │
│  当前请求数：6                                                   │
│                                                                 │
│  Gateway 想：                                                    │
│    6 <= 10？                                                    │
│    ✅ 是的，没有超过限制                                         │
│    可以通过                                                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ✅ 通过
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 6 步：Gateway 转发请求到 UserService                         │
│                                                                 │
│  Gateway → UserService：                                         │
│    GET http://localhost:8081/user/1                             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 7 步：UserService 处理请求                                   │
│                                                                 │
│  UserService 查数据库，返回数据                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、如果超过限制会怎么样？

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：Gateway 收到第 11 个请求                               │
│                                                                 │
│  请求：GET /user/11                                              │
│  当前时间：10:00:00                                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：Gateway 检查请求路径                                   │
│                                                                 │
│  请求路径：/user/11                                              │
│                                                                 │
│  Gateway 想：                                                    │
│    这是 UserService 的请求                                       │
│    要检查限流                                                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：Gateway 查看计数器                                     │
│                                                                 │
│  计数器：                                                        │
│    key: "user:10:00:00"                                         │
│    value: 10             ← 当前秒已有 10 个请求                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：Gateway 计数器 +1                                      │
│                                                                 │
│  计数器：                                                        │
│    key: "user:10:00:00"                                         │
│    value: 10 + 1 = 11    ← 计数器 +1                           │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 5 步：Gateway 检查是否超过限制                               │
│                                                                 │
│  限流规则：每秒最多 10 个请求                                    │
│  当前请求数：11                                                  │
│                                                                 │
│  Gateway 想：                                                    │
│    11 <= 10？                                                   │
│    ❌ 不是，超过限制了                                           │
│    要拒绝这个请求                                                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ❌ 拒绝
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 6 步：Gateway 返回 429 错误                                  │
│                                                                 │
│  Gateway → 客户端：                                              │
│    状态码：429 Too Many Requests                                │
│    消息：请求太频繁，请稍后重试                                  │
│                                                                 │
│  不转发到 UserService！                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、计数器怎么清零？

```
┌─────────────────────────────────────────────────────────────────┐
│  当前时间：10:00:00                                              │
│                                                                 │
│  计数器：                                                        │
│    key: "user:10:00:00"                                         │
│    value: 10             ← 这一秒有 10 个请求                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 1 秒后
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  当前时间：10:00:01                                              │
│                                                                 │
│  Gateway 想：                                                    │
│    现在是 10:00:01 了                                            │
│    key 变成 "user:10:00:01"                                     │
│    这是一个新的 key                                              │
│    计数器从 0 开始                                               │
│                                                                 │
│  计数器：                                                        │
│    key: "user:10:00:01"                                         │
│    value: 0              ← 新的一秒，计数器清零                 │
└─────────────────────────────────────────────────────────────────┘
```

**人话：**
- 每一秒都有一个新的 key
- 10:00:00 的 key 是 "user:10:00:00"
- 10:00:01 的 key 是 "user:10:00:01"
- 不同的 key，计数器就不一样
- 就像每一秒都换一个新的计数器

---

## 六、核心代码（超级简单）

```java
@Component
public class UserServiceRateLimitFilter implements GlobalFilter {
    
    // 计数器（Map）
    private Map<String, AtomicInteger> counterMap = new ConcurrentHashMap<>();
    
    // 限流规则：每秒最多 10 个请求
    private static final int MAX_REQUESTS = 10;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getPath().value();
        
        // 1. 检查是不是 UserService 的请求
        if (!path.startsWith("/user/")) {
            // 不是 UserService 的请求，直接放行
            return chain.filter(exchange);
        }
        
        // 2. 生成 key（服务名 + 当前秒）
        String currentSecond = String.valueOf(System.currentTimeMillis() / 1000);
        String key = "user:" + currentSecond;
        
        // 3. 获取计数器
        AtomicInteger counter = counterMap.computeIfAbsent(key, k -> new AtomicInteger(0));
        
        // 4. 计数器 +1
        int count = counter.incrementAndGet();
        
        // 5. 检查是否超过限制
        if (count > MAX_REQUESTS) {
            // 超过限制，拒绝
            exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);
            return exchange.getResponse().setComplete();
        }
        
        // 6. 没超过限制，放行
        return chain.filter(exchange);
    }
}
```

**人话翻译：**

```java
public Mono<Void> filter(...) {
    String path = 请求路径;
    
    // 1. 检查是不是 UserService 的请求
    if (path 不是 /user/ 开头) {
        return 直接放行;  // 不是 UserService，不限流
    }
    
    // 2. 生成 key（服务名 + 当前秒）
    String key = "user:" + 当前秒;  // 例如："user:10:00:00"
    
    // 3. 获取计数器
    int counter = 从 Map 里获取(key);  // 例如：5
    
    // 4. 计数器 +1
    counter = counter + 1;  // 5 + 1 = 6
    
    // 5. 检查是否超过限制
    if (counter > 10) {
        return 拒绝;  // 超过 10 个，拒绝
    }
    
    // 6. 没超过限制，放行
    return 继续往下走;
}
```

---

## 七、简化版流程图

```
请求：GET /user/1
  │
  │ ① Gateway 收到请求
  ↓
Gateway
  │
  │ ② 检查路径：/user/1 → 是 UserService 的请求 ✅
  │ ③ 生成 key："user:10:00:00"
  │ ④ 查看计数器：5 个请求
  │ ⑤ 计数器 +1：5 + 1 = 6
  │ ⑥ 检查限制：6 <= 10？✅ 是的
  │ ⑦ 放行
  ↓
UserService
  │
  │ ⑧ 处理请求
  │ ⑨ 返回数据
```

---

## 八、关键点总结

### 1. Gateway 怎么知道是 UserService 的请求？

**答案：看请求路径**

```
请求路径：/user/1
  ↓
Gateway 检查：路径是 /user/ 开头的
  ↓
Gateway 知道：这是 UserService 的请求
```

---

### 2. Gateway 怎么记录请求数？

**答案：用计数器（Map）**

```
Map<String, Integer> counterMap = {
    "user:10:00:00": 5,    ← UserService 在 10:00:00 这一秒有 5 个请求
    "user:10:00:01": 3,    ← UserService 在 10:00:01 这一秒有 3 个请求
    "order:10:00:00": 8,   ← OrderService 在 10:00:00 这一秒有 8 个请求
}
```

---

### 3. Gateway 怎么限流？

**答案：数数，超过就拒绝**

```
步骤：
  1. 看请求路径，知道是哪个服务
  2. 生成 key（服务名 + 当前秒）
  3. 从 Map 里获取计数器
  4. 计数器 +1
  5. 检查是否超过限制
  6. 超过就拒绝，没超过就放行
```

---

### 4. 计数器怎么清零？

**答案：每一秒都有一个新的 key**

```
10:00:00 → key = "user:10:00:00" → 计数器 = 10
10:00:01 → key = "user:10:00:01" → 计数器 = 0（新的 key，重新开始）
10:00:02 → key = "user:10:00:02" → 计数器 = 0（新的 key，重新开始）
```

---

## 九、一句话总结

**Gateway 限流 UserService 就像数数：**

1. **看路径**：请求路径是 /user/** 开头的，就知道是 UserService 的请求
2. **生成 key**：服务名 + 当前秒（例如："user:10:00:00"）
3. **查计数器**：从 Map 里获取这个 key 的计数器（例如：5）
4. **计数器 +1**：5 + 1 = 6
5. **检查限制**：6 <= 10？是的，放行 ✅；不是，拒绝 ❌
6. **每秒清零**：每一秒都有一个新的 key，计数器重新开始

**就这么简单！Gateway 就是通过看请求路径，知道是哪个服务的请求，然后用计数器数数，超过限制就拒绝！**
