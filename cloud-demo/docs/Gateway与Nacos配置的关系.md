# Gateway 与 Nacos 配置的关系

## 一、Nacos 控制台截图分析

从截图中可以看到，Nacos 配置列表中有 3 个配置文件：

| Data ID | Group | 说明 |
|---------|-------|------|
| `gateway-dev.yaml` | `DEFAULT_GROUP` | Gateway 开发环境配置 |
| `gateway-dev.yml` | `DEFAULT_GROUP` | Gateway 开发环境配置（另一个） |
| `userservice-dev.yaml` | `DEFAULT_GROUP` | UserService 开发环境配置 |

**重点：** `gateway-dev.yaml` 和 `gateway-dev.yml` 是 Gateway 的配置文件

## 二、配置加载关系

### 2.1 Gateway 如何加载 Nacos 配置

```
Gateway 启动
    ↓
读取 bootstrap.yml（如果有）
    ├─ spring.application.name: gateway
    ├─ spring.profiles.active: dev
    └─ spring.cloud.nacos.server-addr: localhost:8848
    ↓
连接 Nacos Server
    ↓
构建 Data ID：gateway-dev.yaml
    (规则：应用名-环境.扩展名)
    ↓
从 Nacos 拉取配置：gateway-dev.yaml
    ↓
解析配置并加载路由规则
    ↓
Gateway 启动完成
```

### 2.2 配置文件对应关系

```
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 控制台                                                    │
│  配置管理 → 配置列表 → dev 命名空间                              │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Data ID: gateway-dev.yaml                                 │ │
│  │ Group: DEFAULT_GROUP                                      │ │
│  │                                                           │ │
│  │ 配置内容：                                                 │ │
│  │   spring:                                                 │ │
│  │     cloud:                                                │ │
│  │       gateway:                                            │ │
│  │         routes:                                           │ │
│  │           - id: user-service                              │ │
│  │             uri: lb://userservice                         │ │
│  │             predicates:                                   │ │
│  │               - Path=/user/**                             │ │
│  │           - id: order-service                             │ │
│  │             uri: lb://orderservice                        │ │
│  │             predicates:                                   │ │
│  │               - Path=/order/**                            │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ Gateway 启动时自动拉取
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway 应用                                                    │
│                                                                 │
│  加载配置后，Gateway 内部的路由表：                               │
│                                                                 │
│  路由 1：                                                        │
│    ID: user-service                                             │
│    URI: lb://userservice                                        │
│    断言: Path=/user/**                                          │
│                                                                 │
│  路由 2：                                                        │
│    ID: order-service                                            │
│    URI: lb://orderservice                                       │
│    断言: Path=/order/**                                         │
└─────────────────────────────────────────────────────────────────┘
```

## 三、完整的配置和转发关系

### 3.1 三层关系图

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 层：Nacos 配置中心（配置存储）                              │
│                                                                 │
│  gateway-dev.yaml:                                              │
│    routes:                                                      │
│      - id: user-service                                         │
│        uri: lb://userservice                                    │
│        predicates:                                              │
│          - Path=/user/**                                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ① Gateway 启动时拉取配置
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 层：Gateway 路由表（配置使用）                              │
│                                                                 │
│  路由规则：                                                      │
│    如果请求路径匹配 /user/**                                     │
│    就转发到 lb://userservice                                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ② 客户端请求到达
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 层：Nacos 服务注册中心（服务发现）                          │
│                                                                 │
│  服务列表：                                                      │
│    userservice:                                                 │
│      - 192.168.1.100:8081                                       │
│      - 192.168.1.101:8081                                       │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ③ Gateway 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 层：实际转发（请求转发）                                    │
│                                                                 │
│  转发到：http://192.168.1.100:8081/user/1                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 详细流程

```
步骤 1：配置阶段（在 Nacos 控制台）
  ┌─────────────────────────────────────────────────────────────┐
  │ 管理员在 Nacos 控制台创建配置                                 │
  │                                                             │
  │ Data ID: gateway-dev.yaml                                   │
  │ 内容：                                                       │
  │   routes:                                                   │
  │     - id: user-service                                      │
  │       uri: lb://userservice                                 │
  │       predicates:                                           │
  │         - Path=/user/**                                     │
  │                                                             │
  │ 点击"发布"按钮                                               │
  └─────────────────────────────────────────────────────────────┘

步骤 2：启动阶段（Gateway 应用启动）
  ┌─────────────────────────────────────────────────────────────┐
  │ Gateway 启动                                                 │
  │   ↓                                                         │
  │ 读取 bootstrap.yml                                          │
  │   spring.application.name: gateway                          │
  │   spring.profiles.active: dev                               │
  │   ↓                                                         │
  │ 连接 Nacos (localhost:8848)                                 │
  │   ↓                                                         │
  │ 拉取配置：gateway-dev.yaml                                   │
  │   ↓                                                         │
  │ 解析路由配置                                                 │
  │   ↓                                                         │
  │ 注册路由到路由表                                             │
  │   - user-service: Path=/user/** → lb://userservice         │
  │   - order-service: Path=/order/** → lb://orderservice      │
  │   ↓                                                         │
  │ Gateway 启动完成，开始监听 10010 端口                         │
  └─────────────────────────────────────────────────────────────┘

步骤 3：请求阶段（客户端发起请求）
  ┌─────────────────────────────────────────────────────────────┐
  │ 客户端请求：GET http://localhost:10010/user/1               │
  │   ↓                                                         │
  │ Gateway 接收请求                                             │
  │   ↓                                                         │
  │ 匹配路由表                                                   │
  │   请求路径：/user/1                                          │
  │   匹配规则：Path=/user/** ✅                                 │
  │   选择路由：user-service                                     │
  │   目标 URI：lb://userservice                                │
  │   ↓                                                         │
  │ 解析 lb://userservice                                       │
  │   lb = LoadBalance（需要负载均衡）                           │
  │   服务名：userservice                                        │
  │   ↓                                                         │
  │ 查询 Nacos 服务注册中心                                      │
  │   查询服务名：userservice                                    │
  │   返回实例列表：                                             │
  │     - 192.168.1.100:8081                                    │
  │     - 192.168.1.101:8081                                    │
  │   ↓                                                         │
  │ 负载均衡选择实例                                             │
  │   算法：轮询                                                 │
  │   选择：192.168.1.100:8081                                  │
  │   ↓                                                         │
  │ 转发请求                                                     │
  │   目标：http://192.168.1.100:8081/user/1                    │
  └─────────────────────────────────────────────────────────────┘
```

## 四、Nacos 的两个作用

### 4.1 作用 1：配置中心（存储路由规则）

```
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 配置中心                                                  │
│                                                                 │
│  存储内容：gateway-dev.yaml                                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ spring:                                                   │ │
│  │   cloud:                                                  │ │
│  │     gateway:                                              │ │
│  │       routes:                                             │ │
│  │         - id: user-service                                │ │
│  │           uri: lb://userservice      ← 这里定义路由规则    │ │
│  │           predicates:                                     │ │
│  │             - Path=/user/**                               │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  作用：告诉 Gateway 如何路由请求                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 作用 2：服务注册中心（存储服务实例）

```
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册中心                                              │
│                                                                 │
│  服务列表：                                                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：userservice                                       │ │
│  │ 实例列表：                                                 │ │
│  │   - 192.168.1.100:8081  ← UserService 实例 1             │ │
│  │   - 192.168.1.101:8081  ← UserService 实例 2             │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：orderservice                                      │ │
│  │ 实例列表：                                                 │ │
│  │   - 192.168.1.102:8082  ← OrderService 实例 1            │ │
│  │   - 192.168.1.103:8082  ← OrderService 实例 2            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  作用：告诉 Gateway 服务实例在哪里                               │
└─────────────────────────────────────────────────────────────────┘
```

## 五、完整的请求流程（结合 Nacos）

```
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│  发送请求：GET http://localhost:10010/user/1                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (端口 10010)                                            │
│                                                                 │
│  ① 接收请求：/user/1                                             │
│                                                                 │
│  ② 查找路由表（来自 Nacos 配置中心）                             │
│     路由规则：Path=/user/** → lb://userservice                  │
│     匹配成功！                                                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ③ 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册中心                                              │
│                                                                 │
│  Gateway 查询：userservice 有哪些实例？                          │
│                                                                 │
│  Nacos 返回：                                                    │
│    - 192.168.1.100:8081                                         │
│    - 192.168.1.101:8081                                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ④ 返回实例列表
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (端口 10010)                                            │
│                                                                 │
│  ⑤ 负载均衡选择：192.168.1.100:8081                              │
│                                                                 │
│  ⑥ 转发请求：http://192.168.1.100:8081/user/1                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑦ 转发请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  UserService (192.168.1.100:8081)                               │
│                                                                 │
│  ⑧ 处理请求并返回数据                                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑨ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (端口 10010)                                            │
│                                                                 │
│  ⑩ 转发响应给客户端                                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑪ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│  收到数据：{"id":1,"name":"张三"}                                │
└─────────────────────────────────────────────────────────────────┘
```

## 六、配置修改的影响

### 6.1 修改 Nacos 配置

```
场景：在 Nacos 控制台修改 gateway-dev.yaml

修改前：
  routes:
    - id: user-service
      uri: lb://userservice
      predicates:
        - Path=/user/**

修改后：
  routes:
    - id: user-service
      uri: lb://userservice
      predicates:
        - Path=/api/user/**    ← 修改了路径

点击"发布"
    ↓
Nacos 推送配置变更通知
    ↓
Gateway 接收通知
    ↓
Gateway 重新加载路由配置
    ↓
新的路由规则生效

结果：
  - 旧路径 /user/1 不再匹配，返回 404
  - 新路径 /api/user/1 可以匹配，正常转发
```

### 6.2 服务实例变化

```
场景：新增一个 UserService 实例

UserService 实例 3 启动
    ↓
注册到 Nacos：192.168.1.102:8081
    ↓
Nacos 服务列表更新：
  userservice:
    - 192.168.1.100:8081
    - 192.168.1.101:8081
    - 192.168.1.102:8081  ← 新增
    ↓
Gateway 下次查询时获取到新的实例列表
    ↓
负载均衡会包含新实例

结果：
  - 请求会分散到 3 个实例
  - 每个实例的负载降低
```

## 七、总结（人话版）

### 7.1 Nacos 的两个角色

**角色 1：配置中心**
```
Nacos：我存储了 Gateway 的路由规则
Gateway：我启动时从你这里读取路由规则
Nacos：好的，这是 gateway-dev.yaml 配置文件
Gateway：收到！我知道 /user/** 要转发到 userservice 了
```

**角色 2：服务注册中心**
```
UserService：我启动了，地址是 192.168.1.100:8081
Nacos：好的，我记录下来
Gateway：Nacos，userservice 有哪些实例？
Nacos：有 2 个：192.168.1.100:8081 和 192.168.1.101:8081
Gateway：好的，我选第一个转发
```

### 7.2 完整关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Nacos Server                             │
│                                                                 │
│  ┌─────────────────────┐      ┌─────────────────────┐          │
│  │   配置中心           │      │   服务注册中心       │          │
│  │                     │      │                     │          │
│  │ gateway-dev.yaml    │      │ userservice:        │          │
│  │   routes:           │      │   - 实例1           │          │
│  │     - Path=/user/** │      │   - 实例2           │          │
│  │       → userservice │      │                     │          │
│  └─────────────────────┘      └─────────────────────┘          │
│         │                              │                        │
│         │ ① 拉取路由配置                │ ③ 查询服务实例         │
└─────────┼──────────────────────────────┼────────────────────────┘
          │                              │
          ↓                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                         Gateway                                 │
│                                                                 │
│  ② 加载路由规则                  ④ 获取实例列表                  │
│     /user/** → userservice         [实例1, 实例2]               │
│                                                                 │
│  ⑤ 接收请求：/user/1                                             │
│  ⑥ 匹配路由：userservice                                         │
│  ⑦ 选择实例：实例1                                               │
│  ⑧ 转发请求：http://实例1/user/1                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 一句话总结

> **Nacos 配置中心**告诉 Gateway **怎么路由**（/user/** → userservice），**Nacos 服务注册中心**告诉 Gateway **路由到哪里**（userservice 的实例地址），Gateway 结合这两个信息完成请求转发。
