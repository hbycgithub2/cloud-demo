# 人保车险优惠券抢购高并发场景 - 面试终极版

> **快速记忆版本**：面试前5分钟快速看  
> **文档版本**：V1.0  
> **创建时间**：2026-02-02

---

## 🎯 30秒开场白（必背）

"我在人保车险项目中负责优惠券抢购功能的开发。这是2025年1月的'开门红'活动，限量10000张优惠券，立减200元。活动吸引了10万人参与，QPS达到833次/秒，相对平时增长333倍。

我负责核心模块的设计和开发：**Redis + Lua脚本防超卖、Sentinel限流保护系统、Kafka异步写入提升响应速度**。

遇到的最大挑战是：QPS 3000时，应用服务器CPU 100%，响应时间P95 1500ms。我通过**扩容到30台服务器、增加Kafka消费者、验证码异步校验**，优化后响应时间P95降到500ms，提升67%。

这个项目让我深入理解了高并发场景的设计和优化，掌握了Redis、Kafka、Sentinel的实战应用。"

---

## 📋 5个必问（必背）

### 必问1：你们的QPS是多少？

**标准答案：**
"我们的QPS是**833次/秒**（正常估计），峰值QPS **1666次/秒**（前30秒）。

虽然绝对并发量不高，但我们车险业务平时QPS只有2.5次/秒，优惠券抢购时QPS达到833次/秒，**相对增长333倍**。

我们要解决的问题和电商秒杀是一样的：**防超卖、防刷、高可用**。"

**核心数字：**
- 平时QPS：2.5次/秒
- 抢券QPS：833次/秒
- 峰值QPS：1666次/秒
- 相对增长：333倍

---

### 必问2：为什么用Redis而不是MySQL？

**标准答案：**
"我们对比了3种方案：**MySQL加锁、Redis + Lua、分布式锁**。

**MySQL加锁**：QPS只有100-200，无法支撑833次/秒。

**分布式锁**：需要引入Zookeeper或Redisson，增加系统复杂度。

**Redis + Lua脚本**：QPS 10万+，原子性，简单。

所以我们选择了**Redis + Lua脚本**。"

**核心对比：**
| 方案 | QPS | 复杂度 | 结论 |
|------|-----|--------|------|
| MySQL加锁 | 100-200 | 简单 | 性能不够 |
| 分布式锁 | 5000+ | 复杂 | 过度设计 |
| Redis + Lua | 10万+ | 简单 | ✅ 选择 |

---

### 必问3：Redis宕机了怎么办？

**标准答案：**
"我们有3个方案：**Redis集群、本地缓存、降级**。

**Redis集群**（主方案）：3主3从，主节点宕机，从节点自动切换。

**本地缓存**（备用方案）：应用服务器本地缓存活动信息，Redis宕机时使用本地缓存。

**降级方案**（兜底方案）：Redis宕机时，直接返回'系统繁忙'，不查询MySQL，保护数据库。"

**核心方案：**
- 主方案：Redis集群（3主3从）
- 备用方案：本地缓存（Caffeine）
- 兜底方案：降级（返回"系统繁忙"）

---

### 必问4：Kafka消息丢失了怎么办？

**标准答案：**
"我们有3个方案：**Kafka重试、定时任务补偿、用户查询时补偿**。

**Kafka重试**（第一道防线）：消费失败后，自动重试3次，重试间隔1秒、5秒、10秒。

**定时任务补偿**（第二道防线）：每5分钟执行一次，对比Redis和MySQL数据，发现不一致，补偿写入MySQL。

**用户查询时补偿**（第三道防线）：用户查询优惠券列表时，先查MySQL，如果MySQL没有，再查Redis，如果Redis有，补偿写入MySQL。"

**核心方案：**
- 第一道防线：Kafka重试（3次）
- 第二道防线：定时任务补偿（每5分钟）
- 第三道防线：用户查询时补偿

---

### 必问5：你们的响应时间是多少？

**标准答案：**
"我们的响应时间：**P50 200ms、P95 500ms、P99 1000ms**。

**优化前**：P95 1500ms

**优化后**：P95 500ms（提升67%）

**优化方案**：
1. 验证码异步校验：耗时从20ms降到5ms
2. 分段库存：单Key压力降低10倍
3. 本地缓存：减少Redis查询
4. 扩容服务器：10台 → 30台
5. 增加Kafka消费者：10个 → 20个"

**核心数字：**
- P50：200ms
- P95：500ms（优化前1500ms）
- P99：1000ms
- 提升：67%

---

## 🔥 4个选问（重点准备）

### 选问1：你们怎么防刷的？

**标准答案：**
"我们有5个方案：**验证码、IP限流、用户限流、设备指纹、行为分析**。

**验证码**：滑动验证码，防止脚本刷券。

**IP限流**：1分钟内同一IP最多请求10次。

**用户限流**：每个用户只能领取1张券。

**设备指纹**：同一设备只能领取1张券。

**行为分析**：识别脚本刷券（点击间隔 < 0.1秒）。"

---

### 选问2：你们有没有做压测？

**标准答案：**
"我们做了3个场景的压测：**QPS 833、QPS 1666、QPS 3000**。

**QPS 833**：系统稳定，响应时间P95 450ms。

**QPS 1666**：接近瓶颈，响应时间P95 800ms。

**QPS 3000**：优化前瓶颈（P95 1500ms），优化后稳定（P95 500ms）。"

---

### 选问3：你在这个项目中的角色是什么？

**标准答案：**
"我是**核心开发**，负责**抢券接口、Redis扣减库存、Kafka异步写入**3个核心模块。

**我的贡献**：
1. 设计Lua脚本防超卖
2. 优化响应时间从1500ms降到500ms
3. 压测发现瓶颈并优化

**我的收获**：深入理解Redis、Kafka、Sentinel，掌握高并发场景的设计和优化。"

---

### 选问4：你们的成功率是多少？

**标准答案：**
"我们的成功率：**6.7%**（10000张券 / 150000次请求）。

失败原因分布：**已抢完60%、系统繁忙30%、验证码错误3%**。

系统繁忙30%是因为Sentinel限流，保护系统不被打垮。"

---

## 💡 3个救场话术

### 救场话术1：不知道怎么回答

"这个问题我没有深入研究过，但我可以说说我的理解。我认为...（说出你的理解）。如果有不对的地方，请您指正。"

---

### 救场话术2：被质疑项目真实性

"这个项目是2025年1月做的，我是核心开发，负责抢券接口、Redis扣减库存、Kafka异步写入。我们遇到的最大问题是QPS 3000时，应用服务器CPU 100%，响应时间P95 1500ms。我通过扩容到30台服务器、增加Kafka消费者、验证码异步校验，优化后响应时间P95降到500ms。如果您想了解更多细节，我可以详细说明。"

---

### 救场话术3：被质疑技术方案

"您说得对，XXX方案确实是一个好方案。我们也考虑过，但XXX方案有XXX缺点。我们的方案虽然有XXX不足，但XXX优点。我们的原则是：不过度设计，够用就好。"

---

## ⚠️ 3个陷阱（注意）

### 陷阱1：你们的QPS这么高，为什么不用Nginx限流？

**应对策略：**
"我们的QPS是833次/秒，不算特别高。我们用的是Sentinel限流，不是Nginx限流。Sentinel是应用层限流，可以针对不同接口设置不同的限流规则。Nginx是网关层限流，只能针对整个服务限流。"

---

### 陷阱2：你们的Redis集群是3主3从，为什么不是5主5从？

**应对策略：**
"我们用的是3主3从，不是5主5从。3主3从已经足够支撑QPS 833，而且成本可控。5主5从会增加成本，但性能提升不明显。我们的原则是：不过度设计，够用就好。"

---

### 陷阱3：你们的Kafka分区数是10，为什么不是100？

**应对策略：**
"我们用的是10个分区，不是100个分区。10个分区对应10台应用服务器，每台服务器对应1个分区。100个分区会增加Kafka的管理成本，但性能提升不明显。我们的原则是：分区数 = 服务器数。"

---

## 📊 核心数字速记卡

### 业务数字
- 活动时间：2025年1月1日 上午10:00
- 优惠券数量：10000张
- 优惠金额：200元
- 参与人数：10万人
- 成功率：6.7%
- 使用人数：8000人
- 保费收入：1600万元

### 技术数字
- 平时QPS：2.5次/秒
- 抢券QPS：833次/秒
- 峰值QPS：1666次/秒
- 相对增长：333倍
- P50：200ms
- P95：500ms（优化前1500ms）
- P99：1000ms
- 提升：67%

### 系统数字
- 应用服务器：10台 → 30台
- Redis集群：3主3从
- Kafka分区：10个
- Kafka消费者：10个 → 20个
- 应用CPU：60-70%
- Redis CPU：40-50%
- MySQL CPU：15-25%

---

## 🎯 技术方案速记

### 核心技术栈
```
前端：Vue.js + 防重复点击 + 验证码
    ↓
Nginx：负载均衡（10台服务器）
    ↓
应用服务器：Spring Boot + Sentinel限流
    ↓
Redis Cluster：3主3从 + Lua脚本
    ↓
Kafka：10分区 + 3副本
    ↓
MySQL：主从复制
```

### Lua脚本（核心）
```lua
-- 1. 检查用户是否已领取
if redis.call('exists', userKey) == 1 then
    return -1 -- 用户已领取
end

-- 2. 检查库存是否充足
local stock = tonumber(redis.call('get', stockKey))
if stock == nil or stock <= 0 then
    return 0 -- 库存不足
end

-- 3. 扣减库存
redis.call('decr', stockKey)

-- 4. 标记用户已领取
redis.call('setex', userKey, 86400, '1')

-- 5. 返回剩余库存
return redis.call('get', stockKey)
```

---

## ✅ 面试前检查清单

### 面试前1天
- [ ] 复习技术全面版文档（1小时）
- [ ] 复习面试终极版文档（30分钟）
- [ ] 复习核心数字（10分钟）

### 面试前1小时
- [ ] 复习30秒开场白（5分钟）
- [ ] 复习5个必问问题（10分钟）
- [ ] 复习核心数字（5分钟）

### 面试前5分钟
- [ ] 快速过一遍核心数字
- [ ] 快速过一遍30秒开场白
- [ ] 深呼吸，保持自信

---

## 🌟 面试成功的5个关键

1. **真实**（70%）：说出具体的时间、地点、人物、数据
2. **深度**（20%）：说出技术原理、方案对比、权衡利弊
3. **价值**（10%）：说出业务价值、量化数据、经验教训
4. **热情**（加分项）：对技术有热情，对项目有热情
5. **谦虚**（加分项）：承认不足，说出优化空间

---

## 📝 STAR法则模板

**S（情境）：**
"2025年1月，人保车险'开门红'活动，限量10000张优惠券，10万人参与，QPS 833次/秒。"

**T（任务）：**
"我负责优惠券抢购功能的开发，核心任务是：防超卖、防刷、高可用、响应时间 < 1秒。"

**A（行动）：**
"我设计了完整的技术方案：Redis + Lua脚本防超卖、Sentinel限流、Kafka异步、验证码防刷、压测优化。"

**R（结果）：**
"活动成功举办，10000张券在3分钟内抢完，系统稳定，响应时间P95 500ms，8000人使用优惠券投保，为公司带来1600万元保费收入。"

---

## 🎉 最后的建议

1. **面试前5分钟**：快速过一遍核心数字和30秒开场白
2. **面试中**：用STAR法则回答问题，说出具体数字
3. **面试后**：总结经验教训，准备下一次面试
4. **保持自信**：相信自己，展示热情

**祝你面试成功！** 🎉

---

**文档版本**：V1.0  
**创建时间**：2026-02-02  
**适用场景**：面试前5分钟快速复习  
**配套文档**：案例-优惠券抢购-人保车险开门红活动-技术全面版.md
