# Gateway 路由转发 - 人话版

## 一、配置回顾

### Gateway 的路由配置

```yaml
# application.yml
spring:
  cloud:
    gateway:
      routes:
        # 用户服务路由
        - id: user-service
          uri: lb://userservice
          predicates:
            - Path=/user/**
        
        # 订单服务路由
        - id: order-service
          uri: lb://orderservice
          predicates:
            - Path=/order/**
```

**人话翻译：**
- 如果请求路径是 `/user/xxx`，就转发到 `userservice` 服务
- 如果请求路径是 `/order/xxx`，就转发到 `orderservice` 服务

## 二、实际转发案例

### 案例 1：访问用户服务

**客户端请求：**
```
GET http://localhost:10010/user/1
```

**转发流程（人话版）：**

```
第 1 步：请求到达 Gateway
  客户端：我要访问 http://localhost:10010/user/1
  Gateway：收到！让我看看该转发到哪里

第 2 步：路由匹配
  Gateway：我有两个路由规则
    - user-service: 路径是 /user/** 的转发到 userservice
    - order-service: 路径是 /order/** 的转发到 orderservice
  
  Gateway：你的路径是 /user/1，匹配第一个规则！
  Gateway：好的，我要把你转发到 userservice

第 3 步：找服务实例
  Gateway：userservice 在哪里呢？让我问问 Nacos
  
  Gateway → Nacos：userservice 有哪些实例？
  Nacos → Gateway：有 2 个实例：
    - 192.168.1.100:8081
    - 192.168.1.101:8081

第 4 步：负载均衡选择
  Gateway：有 2 个实例，我用轮询算法选一个
  Gateway：这次选第 1 个：192.168.1.100:8081

第 5 步：转发请求
  Gateway：好的，我现在把请求转发过去
  Gateway → UserService：GET http://192.168.1.100:8081/user/1

第 6 步：接收响应
  UserService → Gateway：这是数据 {"id":1,"name":"张三"}
  Gateway → 客户端：给你，这是你要的数据
```

### 案例 2：访问订单服务

**客户端请求：**
```
GET http://localhost:10010/order/101
```

**转发流程（人话版）：**

```
第 1 步：请求到达 Gateway
  客户端：我要访问 http://localhost:10010/order/101
  Gateway：收到！

第 2 步：路由匹配
  Gateway：你的路径是 /order/101
  Gateway：匹配到 order-service 规则！
  Gateway：要转发到 orderservice

第 3 步：找服务实例
  Gateway → Nacos：orderservice 有哪些实例？
  Nacos → Gateway：有 2 个实例：
    - 192.168.1.102:8082
    - 192.168.1.103:8082

第 4 步：负载均衡选择
  Gateway：轮询算法，这次选第 2 个：192.168.1.103:8082

第 5 步：转发请求
  Gateway → OrderService：GET http://192.168.1.103:8082/order/101

第 6 步：接收响应
  OrderService → Gateway：订单数据 {"id":101,"userId":1}
  Gateway → 客户端：给你数据
```

## 三、完整流程图（人话版）

### 3.1 访问用户服务流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端                                   │
│                                                                 │
│  浏览器输入：http://localhost:10010/user/1                       │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ① 发送请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Gateway (端口 10010)                          │
│                                                                 │
│  ② 收到请求，开始匹配路由                                         │
│     请求路径：/user/1                                            │
│                                                                 │
│  ③ 检查路由规则                                                  │
│     规则 1：Path=/user/** → ✅ 匹配成功！                        │
│     选择路由：user-service                                       │
│     目标服务：lb://userservice                                   │
│                                                                 │
│  ④ 询问 Nacos：userservice 在哪里？                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Nacos (端口 8848)                             │
│                                                                 │
│  ⑤ 查询服务注册表                                                │
│     服务名：userservice                                          │
│     实例列表：                                                   │
│       - 192.168.1.100:8081 ✅ 健康                              │
│       - 192.168.1.101:8081 ✅ 健康                              │
│                                                                 │
│  ⑥ 返回实例列表给 Gateway                                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 返回实例列表
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Gateway (端口 10010)                          │
│                                                                 │
│  ⑦ 负载均衡选择                                                  │
│     算法：轮询                                                   │
│     本次选择：192.168.1.100:8081                                 │
│                                                                 │
│  ⑧ 转发请求                                                      │
│     目标地址：http://192.168.1.100:8081/user/1                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 转发请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              UserService (192.168.1.100:8081)                   │
│                                                                 │
│  ⑨ 处理请求                                                      │
│     接收：GET /user/1                                            │
│     查询数据库：SELECT * FROM user WHERE id = 1                  │
│     返回数据：{"id":1,"name":"张三","age":20}                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Gateway (端口 10010)                          │
│                                                                 │
│  ⑩ 接收响应并转发给客户端                                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                         客户端                                   │
│                                                                 │
│  ⑪ 收到数据：{"id":1,"name":"张三","age":20}                     │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 访问订单服务流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端                                   │
│                                                                 │
│  浏览器输入：http://localhost:10010/order/101                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ① 发送请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Gateway (端口 10010)                          │
│                                                                 │
│  ② 收到请求，开始匹配路由                                         │
│     请求路径：/order/101                                         │
│                                                                 │
│  ③ 检查路由规则                                                  │
│     规则 1：Path=/user/** → ❌ 不匹配                            │
│     规则 2：Path=/order/** → ✅ 匹配成功！                       │
│     选择路由：order-service                                      │
│     目标服务：lb://orderservice                                  │
│                                                                 │
│  ④ 询问 Nacos：orderservice 在哪里？                             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Nacos (端口 8848)                             │
│                                                                 │
│  ⑤ 查询服务注册表                                                │
│     服务名：orderservice                                         │
│     实例列表：                                                   │
│       - 192.168.1.102:8082 ✅ 健康                              │
│       - 192.168.1.103:8082 ✅ 健康                              │
│                                                                 │
│  ⑥ 返回实例列表给 Gateway                                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 返回实例列表
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Gateway (端口 10010)                          │
│                                                                 │
│  ⑦ 负载均衡选择                                                  │
│     算法：轮询                                                   │
│     本次选择：192.168.1.102:8082                                 │
│                                                                 │
│  ⑧ 转发请求                                                      │
│     目标地址：http://192.168.1.102:8082/order/101                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 转发请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│             OrderService (192.168.1.102:8082)                   │
│                                                                 │
│  ⑨ 处理请求                                                      │
│     接收：GET /order/101                                         │
│     查询数据库：SELECT * FROM orders WHERE id = 101              │
│     返回数据：{"id":101,"userId":1,"total":99.9}                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Gateway (端口 10010)                          │
│                                                                 │
│  ⑩ 接收响应并转发给客户端                                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                         客户端                                   │
│                                                                 │
│  ⑪ 收到数据：{"id":101,"userId":1,"total":99.9}                 │
└─────────────────────────────────────────────────────────────────┘
```

## 四、路径匹配规则（人话版）

### 4.1 匹配规则

| 请求路径 | 匹配规则 | 是否匹配 | 转发到 |
|---------|---------|---------|--------|
| `/user/1` | `Path=/user/**` | ✅ 是 | userservice |
| `/user/123` | `Path=/user/**` | ✅ 是 | userservice |
| `/user/list` | `Path=/user/**` | ✅ 是 | userservice |
| `/order/101` | `Path=/user/**` | ❌ 否 | - |
| `/order/101` | `Path=/order/**` | ✅ 是 | orderservice |
| `/order/list` | `Path=/order/**` | ✅ 是 | orderservice |
| `/product/1` | `Path=/user/**` | ❌ 否 | - |
| `/product/1` | `Path=/order/**` | ❌ 否 | - |

**人话解释：**
- `**` 表示匹配任意多层路径
- `/user/**` 匹配所有以 `/user/` 开头的路径
- `/order/**` 匹配所有以 `/order/` 开头的路径

### 4.2 匹配过程

```
请求：GET /user/1

Gateway 的思考过程：
  1. 看看路径是什么：/user/1
  2. 遍历我的路由规则：
     - 第 1 条：Path=/user/** 
       → /user/1 是不是以 /user/ 开头？
       → 是的！匹配成功！
       → 转发到 userservice
     - 不用看第 2 条了，已经找到了

请求：GET /order/101

Gateway 的思考过程：
  1. 看看路径是什么：/order/101
  2. 遍历我的路由规则：
     - 第 1 条：Path=/user/**
       → /order/101 是不是以 /user/ 开头？
       → 不是！继续下一条
     - 第 2 条：Path=/order/**
       → /order/101 是不是以 /order/ 开头？
       → 是的！匹配成功！
       → 转发到 orderservice

请求：GET /product/1

Gateway 的思考过程：
  1. 看看路径是什么：/product/1
  2. 遍历我的路由规则：
     - 第 1 条：Path=/user/** → 不匹配
     - 第 2 条：Path=/order/** → 不匹配
  3. 没有匹配的路由！
  4. 返回 404 Not Found
```

## 五、负载均衡（人话版）

### 5.1 为什么需要负载均衡？

**场景：**
```
userservice 有 2 个实例：
  - 实例 1：192.168.1.100:8081
  - 实例 2：192.168.1.101:8081

问题：Gateway 应该转发到哪个实例？
```

**解决方案：负载均衡**
```
Gateway：我用轮询算法，轮流选择

第 1 次请求 → 选择实例 1 (192.168.1.100:8081)
第 2 次请求 → 选择实例 2 (192.168.1.101:8081)
第 3 次请求 → 选择实例 1 (192.168.1.100:8081)
第 4 次请求 → 选择实例 2 (192.168.1.101:8081)
...

好处：
  - 请求分散到多个实例，不会压垮单个实例
  - 如果一个实例挂了，还有其他实例可以用
```

### 5.2 负载均衡过程

```
┌─────────────────────────────────────────────────────────────────┐
│  Gateway 收到请求：GET /user/1                                   │
│                                                                 │
│  匹配到路由：lb://userservice                                    │
│                                                                 │
│  Gateway：lb:// 是什么意思？                                     │
│  Gateway：lb = LoadBalance（负载均衡）                           │
│  Gateway：我需要从 Nacos 获取 userservice 的所有实例             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway → Nacos：给我 userservice 的实例列表                    │
│                                                                 │
│  Nacos → Gateway：有 2 个实例：                                  │
│    - 192.168.1.100:8081                                         │
│    - 192.168.1.101:8081                                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway：好的，我有 2 个实例可以选                               │
│                                                                 │
│  Gateway：用轮询算法选一个                                       │
│    当前轮询位置：0                                               │
│    选择：实例列表[0] = 192.168.1.100:8081                        │
│    下次轮询位置：1                                               │
│                                                                 │
│  Gateway：好的，转发到 http://192.168.1.100:8081/user/1          │
└─────────────────────────────────────────────────────────────────┘
```

## 六、完整对比图

### 6.1 没有 Gateway 的情况

```
客户端直接访问服务：

┌──────────┐
│  客户端   │
└──────────┘
     │
     ├─────────→ http://192.168.1.100:8081/user/1
     │
     └─────────→ http://192.168.1.102:8082/order/101

问题：
  1. 客户端需要知道每个服务的地址
  2. 服务地址变了，客户端也要改
  3. 没有统一的鉴权、日志等功能
```

### 6.2 有 Gateway 的情况

```
客户端只访问 Gateway：

┌──────────┐
│  客户端   │
└──────────┘
     │
     │ 统一入口：http://localhost:10010
     ↓
┌──────────────────────────────────────┐
│           Gateway                    │
│  - 路由转发                           │
│  - 负载均衡                           │
│  - 统一鉴权                           │
│  - 日志记录                           │
└──────────────────────────────────────┘
     │
     ├─────────→ UserService (多个实例)
     │
     └─────────→ OrderService (多个实例)

好处：
  1. 客户端只需要知道 Gateway 地址
  2. 服务地址变了，只需要在 Nacos 更新
  3. 统一处理鉴权、日志等功能
```

## 七、总结（一句话版）

**Gateway 路由转发的本质：**

> Gateway 就像一个**快递分拣中心**，收到包裹（请求）后，看看地址（路径），然后根据规则（路由配置）决定送到哪个快递站（服务实例），如果有多个快递站（多个实例），就轮流送（负载均衡）。

**具体流程：**

1. **收快递**：Gateway 收到请求
2. **看地址**：检查请求路径（/user/1 还是 /order/101）
3. **查规则**：匹配路由配置（Path=/user/** 还是 Path=/order/**）
4. **找快递站**：从 Nacos 获取服务实例列表
5. **选快递站**：用负载均衡算法选一个实例
6. **送快递**：把请求转发到选中的实例
7. **收回执**：接收响应并返回给客户端

**关键点：**
- `/user/**` 的请求 → 转发到 `userservice`
- `/order/**` 的请求 → 转发到 `orderservice`
- 多个实例 → 轮流选择（负载均衡）
- 统一入口 → 客户端只需要知道 Gateway 地址
