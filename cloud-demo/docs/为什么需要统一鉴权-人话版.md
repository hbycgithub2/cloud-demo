# 为什么需要统一鉴权 - 人话版

## 一、Token 的目的是什么？

### 人话版：Token 就是你的身份证

**场景：你去银行办业务**

```
没有 Token（身份证）：
  你：我要取钱
  银行：你是谁？
  你：我是张三
  银行：怎么证明你是张三？
  你：......（无法证明）
  银行：不能办理 ❌

有 Token（身份证）：
  你：我要取钱（出示身份证）
  银行：（看身份证）你是张三，可以办理 ✅
```

**Token 的作用：**
1. **证明你是谁**（身份认证）
2. **证明你有权限**（授权）
3. **防止别人冒充你**（安全）

---

## 二、为什么需要统一鉴权？

### 场景对比

#### 方案 1：不用统一鉴权（每个服务自己验证）

```
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
└─────────────────────────────────────────────────────────────────┘
     │
     │ 带 Token 请求
     ↓
┌─────────────────────────────────────────────────────────────────┐
│  UserService                                                     │
│                                                                 │
│  收到请求 → 验证 Token ✅ → 处理业务                             │
│                                                                 │
│  鉴权代码：100 行                                                │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  OrderService                                                    │
│                                                                 │
│  收到请求 → 验证 Token ✅ → 处理业务                             │
│                                                                 │
│  鉴权代码：100 行（重复代码）                                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  ProductService                                                  │
│                                                                 │
│  收到请求 → 验证 Token ✅ → 处理业务                             │
│                                                                 │
│  鉴权代码：100 行（重复代码）                                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  PaymentService                                                  │
│                                                                 │
│  收到请求 → 验证 Token ✅ → 处理业务                             │
│                                                                 │
│  鉴权代码：100 行（重复代码）                                    │
└─────────────────────────────────────────────────────────────────┘
```

**问题：**
- ❌ 每个服务都要写鉴权代码（100 行 × 4 = 400 行）
- ❌ 代码重复，维护困难
- ❌ 鉴权逻辑改了，4 个服务都要改
- ❌ 新增服务，又要写一遍鉴权代码
- ❌ 性能浪费（每个服务都要验证一次 Token）

**人话比喻：**
- 就像每个商店都要检查你的身份证
- 你去 4 个商店，要被检查 4 次
- 每个商店都要雇一个保安（浪费）

---

#### 方案 2：统一鉴权（Gateway 统一验证）✅

```
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
└─────────────────────────────────────────────────────────────────┘
     │
     │ 带 Token 请求
     ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway（统一入口）                                             │
│                                                                 │
│  收到请求 → 验证 Token ✅ → 转发请求                             │
│                                                                 │
│  鉴权代码：100 行（只写一次）                                    │
└─────────────────────────────────────────────────────────────────┘
     │
     ├─→ UserService（不需要验证 Token，直接处理业务）
     ├─→ OrderService（不需要验证 Token，直接处理业务）
     ├─→ ProductService（不需要验证 Token，直接处理业务）
     └─→ PaymentService（不需要验证 Token，直接处理业务）
```

**优点：**
- ✅ 鉴权代码只写一次（100 行）
- ✅ 没有重复代码
- ✅ 鉴权逻辑改了，只需要改 Gateway
- ✅ 新增服务，不需要写鉴权代码
- ✅ 性能好（只验证一次 Token）
- ✅ 后端服务专注业务逻辑

**人话比喻：**
- 就像小区只有一个大门，只在大门检查身份证
- 进了小区后，各个楼栋不用再检查
- 只需要雇一个保安（节省成本）

---

## 三、不用统一鉴权会怎么样？

### 问题 1：代码重复，维护困难

```java
// UserService 的鉴权代码
@Component
public class UserAuthFilter {
    public void filter(HttpServletRequest request) {
        String token = request.getHeader("Authorization");
        Claims claims = Jwts.parser()
            .setSigningKey("secret-key")
            .parseClaimsJws(token)
            .getBody();
        // ... 100 行代码
    }
}

// OrderService 的鉴权代码（重复）
@Component
public class OrderAuthFilter {
    public void filter(HttpServletRequest request) {
        String token = request.getHeader("Authorization");
        Claims claims = Jwts.parser()
            .setSigningKey("secret-key")
            .parseClaimsJws(token)
            .getBody();
        // ... 100 行代码（和 UserService 一模一样）
    }
}

// ProductService 的鉴权代码（重复）
@Component
public class ProductAuthFilter {
    public void filter(HttpServletRequest request) {
        String token = request.getHeader("Authorization");
        Claims claims = Jwts.parser()
            .setSigningKey("secret-key")
            .parseClaimsJws(token)
            .getBody();
        // ... 100 行代码（和 UserService 一模一样）
    }
}
```

**问题：**
- 4 个服务，4 份一模一样的代码
- 改一个地方，要改 4 次
- 容易出错，维护困难

---

### 问题 2：鉴权逻辑改了，所有服务都要改

**场景：密钥要换了**

```
旧密钥：secret-key
新密钥：new-secret-key-2024

不用统一鉴权：
  ❌ UserService 要改
  ❌ OrderService 要改
  ❌ ProductService 要改
  ❌ PaymentService 要改
  ❌ 改 4 次，容易漏改

用统一鉴权：
  ✅ 只需要改 Gateway
  ✅ 改 1 次就行
```

---

### 问题 3：新增服务，又要写一遍鉴权代码

```
不用统一鉴权：
  新增 CommentService
  → 又要写 100 行鉴权代码
  → 又要测试鉴权功能
  → 浪费时间

用统一鉴权：
  新增 CommentService
  → 不需要写鉴权代码
  → Gateway 自动帮你验证
  → 专注业务逻辑
```

---

### 问题 4：性能浪费

```
不用统一鉴权：
  客户端 → UserService → 验证 Token（耗时 10ms）
  客户端 → OrderService → 验证 Token（耗时 10ms）
  客户端 → ProductService → 验证 Token（耗时 10ms）
  
  总耗时：30ms

用统一鉴权：
  客户端 → Gateway → 验证 Token（耗时 10ms）
           ├→ UserService（不验证）
           ├→ OrderService（不验证）
           └→ ProductService（不验证）
  
  总耗时：10ms
```

---

### 问题 5：安全风险

```
不用统一鉴权：
  每个服务都要管理密钥
  → 密钥泄露风险高
  → 4 个服务，4 个地方可能泄露

用统一鉴权：
  只有 Gateway 管理密钥
  → 密钥泄露风险低
  → 只有 1 个地方需要保护
```

---

## 四、真实场景对比

### 场景：电商系统

**系统架构：**
- UserService（用户服务）
- OrderService（订单服务）
- ProductService（商品服务）
- PaymentService（支付服务）
- CartService（购物车服务）
- CommentService（评论服务）

---

### 方案 1：不用统一鉴权

```
┌─────────────────────────────────────────────────────────────────┐
│  开发工作量                                                      │
│                                                                 │
│  UserService：写 100 行鉴权代码                                  │
│  OrderService：写 100 行鉴权代码                                 │
│  ProductService：写 100 行鉴权代码                               │
│  PaymentService：写 100 行鉴权代码                               │
│  CartService：写 100 行鉴权代码                                  │
│  CommentService：写 100 行鉴权代码                               │
│                                                                 │
│  总代码量：600 行                                                │
│  开发时间：6 天                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  维护工作量                                                      │
│                                                                 │
│  密钥要换：改 6 个服务                                           │
│  鉴权逻辑要改：改 6 个服务                                       │
│  新增服务：又要写 100 行鉴权代码                                 │
│                                                                 │
│  维护成本：高 ❌                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  性能                                                            │
│                                                                 │
│  每个请求都要验证 Token                                          │
│  6 个服务，验证 6 次                                             │
│                                                                 │
│  性能：差 ❌                                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

### 方案 2：统一鉴权（推荐）✅

```
┌─────────────────────────────────────────────────────────────────┐
│  开发工作量                                                      │
│                                                                 │
│  Gateway：写 100 行鉴权代码                                      │
│  UserService：不需要写鉴权代码                                   │
│  OrderService：不需要写鉴权代码                                  │
│  ProductService：不需要写鉴权代码                                │
│  PaymentService：不需要写鉴权代码                                │
│  CartService：不需要写鉴权代码                                   │
│  CommentService：不需要写鉴权代码                                │
│                                                                 │
│  总代码量：100 行                                                │
│  开发时间：1 天                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  维护工作量                                                      │
│                                                                 │
│  密钥要换：只改 Gateway                                          │
│  鉴权逻辑要改：只改 Gateway                                      │
│  新增服务：不需要写鉴权代码                                      │
│                                                                 │
│  维护成本：低 ✅                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  性能                                                            │
│                                                                 │
│  每个请求只验证一次 Token（在 Gateway）                          │
│  后端服务不需要验证                                              │
│                                                                 │
│  性能：好 ✅                                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、总结

### Token 的目的

```
Token 就像身份证：
  1. 证明你是谁（身份认证）
  2. 证明你有权限（授权）
  3. 防止别人冒充你（安全）
```

### 为什么需要统一鉴权

```
统一鉴权就像小区大门：
  1. 只在大门检查一次身份证
  2. 进了小区后，各个楼栋不用再检查
  3. 节省成本，提高效率
```

### 不用统一鉴权的问题

```
1. 代码重复：每个服务都要写鉴权代码
2. 维护困难：鉴权逻辑改了，所有服务都要改
3. 开发浪费：新增服务，又要写一遍鉴权代码
4. 性能浪费：每个服务都要验证一次 Token
5. 安全风险：每个服务都要管理密钥
```

### 对比表

| 对比项 | 不用统一鉴权 | 统一鉴权 |
|--------|-------------|----------|
| 代码量 | 600 行（6 个服务 × 100 行） | 100 行（只在 Gateway） |
| 开发时间 | 6 天 | 1 天 |
| 维护成本 | 高（改 6 次） | 低（改 1 次） |
| 性能 | 差（验证 6 次） | 好（验证 1 次） |
| 安全性 | 低（6 个地方管理密钥） | 高（1 个地方管理密钥） |
| 新增服务 | 要写鉴权代码 | 不需要写鉴权代码 |

---

## 六、一句话总结

**统一鉴权就像小区大门的保安：**
- 所有人进小区都要先过保安（Gateway）
- 保安检查身份证（Token）
- 身份证有效就放行，无效就拦截
- 进了小区后，各个楼栋（UserService、OrderService）不用再检查了
- 只需要雇一个保安（节省成本），而不是每个楼栋都雇一个保安（浪费）

**Token 就是你的身份证，证明你是谁，防止别人冒充你！**
