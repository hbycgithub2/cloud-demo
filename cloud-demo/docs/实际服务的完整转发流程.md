# 实际服务的完整转发流程（userservice 和 orderservice）

## 一、cloud-demo 项目实际有的服务

```
cloud-demo/
├── gateway/           ✅ 网关服务（端口 10010）
├── user-service/      ✅ 用户服务（端口 8081）
└── order-service/     ✅ 订单服务（端口 8082）
```

**就这 3 个服务，没有其他的！**

## 二、服务启动和注册过程

### 2.1 启动 UserService

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：启动 UserService                                        │
│                                                                 │
│  在 IDEA 中运行：UserApplication.java                            │
│  或命令行：java -jar user-service.jar                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：UserService 读取配置                                    │
│                                                                 │
│  application.yml:                                               │
│    server:                                                      │
│      port: 8081                                                 │
│    spring:                                                      │
│      application:                                               │
│        name: userservice                                        │
│      cloud:                                                     │
│        nacos:                                                   │
│          server-addr: localhost:8848                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：UserService 自动注册到 Nacos                            │
│                                                                 │
│  UserService → Nacos：                                           │
│    我要注册！                                                    │
│    服务名：userservice                                           │
│    IP：localhost (或 127.0.0.1)                                 │
│    端口：8081                                                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：Nacos 保存注册信息                                      │
│                                                                 │
│  Nacos 服务注册表：                                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：userservice                                       │ │
│  │ 实例列表：                                                 │ │
│  │   - IP: localhost                                         │ │
│  │     端口: 8081                                             │ │
│  │     状态: UP (健康)                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 启动 OrderService

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：启动 OrderService                                       │
│                                                                 │
│  在 IDEA 中运行：OrderApplication.java                           │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：OrderService 读取配置                                   │
│                                                                 │
│  application.yml:                                               │
│    server:                                                      │
│      port: 8082                                                 │
│    spring:                                                      │
│      application:                                               │
│        name: orderservice                                       │
│      cloud:                                                     │
│        nacos:                                                   │
│          server-addr: localhost:8848                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：OrderService 自动注册到 Nacos                           │
│                                                                 │
│  OrderService → Nacos：                                          │
│    我要注册！                                                    │
│    服务名：orderservice                                          │
│    IP：localhost                                                │
│    端口：8082                                                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：Nacos 保存注册信息                                      │
│                                                                 │
│  Nacos 服务注册表：                                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：userservice                                       │ │
│  │ 实例列表：                                                 │ │
│  │   - localhost:8081 (UP)                                   │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：orderservice                                      │ │
│  │ 实例列表：                                                 │ │
│  │   - localhost:8082 (UP)                                   │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 启动 Gateway

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：启动 Gateway                                            │
│                                                                 │
│  在 IDEA 中运行：GatewayApplication.java                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：Gateway 读取配置                                        │
│                                                                 │
│  application.yml:                                               │
│    server:                                                      │
│      port: 10010                                                │
│    spring:                                                      │
│      cloud:                                                     │
│        gateway:                                                 │
│          routes:                                                │
│            - id: user-service                                   │
│              uri: lb://userservice                              │
│              predicates:                                        │
│                - Path=/user/**                                  │
│            - id: order-service                                  │
│              uri: lb://orderservice                             │
│              predicates:                                        │
│                - Path=/order/**                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：Gateway 也注册到 Nacos                                  │
│                                                                 │
│  Gateway → Nacos：                                               │
│    服务名：gateway                                               │
│    IP：localhost                                                │
│    端口：10010                                                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：所有服务都注册完成                                      │
│                                                                 │
│  Nacos 服务注册表：                                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ gateway       → localhost:10010 (UP)                      │ │
│  │ userservice   → localhost:8081 (UP)                       │ │
│  │ orderservice  → localhost:8082 (UP)                       │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 三、完整的请求转发流程

### 3.1 访问用户服务：GET /user/1

```
┌─────────────────────────────────────────────────────────────────┐
│  客户端（浏览器/Postman）                                         │
│                                                                 │
│  发送请求：GET http://localhost:10010/user/1                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ① 请求到达
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ② 接收请求                                                      │
│     路径：/user/1                                                │
│     方法：GET                                                    │
│                                                                 │
│  ③ 匹配路由                                                      │
│     检查路由表：                                                 │
│       - user-service: Path=/user/** → ✅ 匹配！                 │
│       - order-service: Path=/order/** → ❌ 不匹配               │
│                                                                 │
│     选中路由：user-service                                       │
│     目标：lb://userservice                                       │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ④ 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册中心 (localhost:8848)                             │
│                                                                 │
│  Gateway 查询：userservice 有哪些实例？                          │
│                                                                 │
│  Nacos 查找注册表：                                              │
│    服务名：userservice                                           │
│    找到了！                                                      │
│                                                                 │
│  Nacos 返回：                                                    │
│    实例列表：                                                    │
│      - IP: localhost                                            │
│        端口: 8081                                                │
│        状态: UP                                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑤ 返回实例列表
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ⑥ 收到实例列表：                                                │
│     - localhost:8081                                            │
│                                                                 │
│  ⑦ 负载均衡（只有 1 个实例，直接选它）                            │
│     选择：localhost:8081                                         │
│                                                                 │
│  ⑧ 转发请求                                                      │
│     目标：http://localhost:8081/user/1                           │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑨ 转发请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  UserService (localhost:8081)                                   │
│                                                                 │
│  ⑩ 接收请求：GET /user/1                                         │
│                                                                 │
│  ⑪ 处理请求                                                      │
│     UserController.queryById(1)                                 │
│     查询数据库：SELECT * FROM user WHERE id = 1                  │
│                                                                 │
│  ⑫ 返回数据                                                      │
│     {"id":1,"username":"柳岩","address":"湖南省衡阳市"}          │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑬ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ⑭ 接收响应并转发给客户端                                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑮ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│                                                                 │
│  ⑯ 收到数据：{"id":1,"username":"柳岩","address":"湖南省衡阳市"} │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 访问订单服务：GET /order/101

```
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│                                                                 │
│  发送请求：GET http://localhost:10010/order/101                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ① 请求到达
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ② 接收请求：/order/101                                          │
│                                                                 │
│  ③ 匹配路由                                                      │
│     - user-service: Path=/user/** → ❌ 不匹配                   │
│     - order-service: Path=/order/** → ✅ 匹配！                 │
│                                                                 │
│     选中路由：order-service                                      │
│     目标：lb://orderservice                                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ④ 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos (localhost:8848)                                         │
│                                                                 │
│  Gateway 查询：orderservice 有哪些实例？                         │
│                                                                 │
│  Nacos 返回：                                                    │
│    - localhost:8082 (UP)                                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑤ 返回实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ⑥ 选择实例：localhost:8082                                      │
│  ⑦ 转发请求：http://localhost:8082/order/101                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑧ 转发请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  OrderService (localhost:8082)                                  │
│                                                                 │
│  ⑨ 接收请求：GET /order/101                                      │
│  ⑩ 处理请求并返回数据                                            │
│     {"id":101,"price":699900,"name":"Apple 苹果...","num":1}   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑪ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│                                                                 │
│  ⑫ 收到数据                                                      │
└─────────────────────────────────────────────────────────────────┘
```

## 四、关键点说明

### 4.1 服务实例的 IP 和端口从哪来？

```
答案：服务启动时自己注册的！

UserService 启动：
  1. 读取配置：server.port=8081
  2. 获取本机 IP：localhost
  3. 向 Nacos 注册：userservice → localhost:8081

OrderService 启动：
  1. 读取配置：server.port=8082
  2. 获取本机 IP：localhost
  3. 向 Nacos 注册：orderservice → localhost:8082

Gateway 查询时：
  1. 向 Nacos 查询：userservice 在哪？
  2. Nacos 返回：localhost:8081
  3. Gateway 转发到：http://localhost:8081
```

### 4.2 lb:// 是什么意思？

```
lb:// = LoadBalance（负载均衡）

uri: lb://userservice 的含义：
  1. lb:// 告诉 Gateway：这是一个需要负载均衡的服务
  2. userservice 是服务名
  3. Gateway 会去 Nacos 查询 userservice 的所有实例
  4. 如果有多个实例，用负载均衡算法选一个
  5. 如果只有一个实例，直接用那个

对比：
  - uri: lb://userservice → 动态查询 Nacos
  - uri: http://localhost:8081 → 固定地址，不查询 Nacos
```

### 4.3 如果启动多个 UserService 实例会怎样？

```
场景：启动 2 个 UserService 实例

实例 1：
  java -jar user-service.jar --server.port=8081
  注册到 Nacos：localhost:8081

实例 2：
  java -jar user-service.jar --server.port=8083
  注册到 Nacos：localhost:8083

Nacos 注册表：
  userservice:
    - localhost:8081 (UP)
    - localhost:8083 (UP)

Gateway 查询时：
  Nacos 返回：[localhost:8081, localhost:8083]

Gateway 负载均衡：
  请求 1 → localhost:8081
  请求 2 → localhost:8083
  请求 3 → localhost:8081
  请求 4 → localhost:8083
  ...（轮流选择）
```

## 五、实际测试步骤

### 5.1 启动服务

```
步骤 1：启动 Nacos
  cd nacos/bin
  startup.cmd (Windows)
  或 sh startup.sh (Linux/Mac)

步骤 2：启动 UserService
  在 IDEA 中运行 UserApplication
  或：java -jar user-service.jar

步骤 3：启动 OrderService
  在 IDEA 中运行 OrderApplication
  或：java -jar order-service.jar

步骤 4：启动 Gateway
  在 IDEA 中运行 GatewayApplication
  或：java -jar gateway.jar
```

### 5.2 验证服务注册

```
打开浏览器：http://localhost:8848/nacos
登录：nacos/nacos
点击：服务管理 → 服务列表

应该看到：
  ✅ gateway       (1 个实例)
  ✅ userservice   (1 个实例)
  ✅ orderservice  (1 个实例)
```

### 5.3 测试请求

```bash
# 测试 1：直接访问 UserService（不通过 Gateway）
curl http://localhost:8081/user/1

# 预期结果：
# {"id":1,"username":"柳岩","address":"湖南省衡阳市"}

# 测试 2：通过 Gateway 访问 UserService
curl http://localhost:10010/user/1

# 预期结果：
# {"id":1,"username":"柳岩","address":"湖南省衡阳市"}

# 测试 3：通过 Gateway 访问 OrderService
curl http://localhost:10010/order/101

# 预期结果：
# {"id":101,"price":699900,"name":"Apple 苹果...","num":1}
```

## 六、总结

### 6.1 完整流程（一句话）

> UserService 启动时注册到 Nacos (localhost:8081)，客户端请求 Gateway (/user/1)，Gateway 从 Nacos 查到 userservice 的地址 (localhost:8081)，转发请求过去，UserService 处理后返回数据。

### 6.2 核心要点

1. **服务注册**：UserService 和 OrderService 启动时自动注册到 Nacos
2. **服务发现**：Gateway 从 Nacos 查询服务实例的地址
3. **路由匹配**：根据请求路径匹配对应的路由规则
4. **负载均衡**：如果有多个实例，轮流选择
5. **请求转发**：Gateway 把请求转发到选中的实例

### 6.3 实际地址对应

| 服务 | 端口 | 实际地址 | Nacos 注册名 |
|------|------|---------|-------------|
| Gateway | 10010 | localhost:10010 | gateway |
| UserService | 8081 | localhost:8081 | userservice |
| OrderService | 8082 | localhost:8082 | orderservice |

**就这么简单！**
