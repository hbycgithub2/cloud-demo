# Nacos 配置与实际项目服务的对应关系

## 一、重要发现

### 1.1 Nacos 配置中的路由

Nacos 的 `gateway-dev.yaml` 和 `gateway-router` 配置了这些路由：

```
1. admin      → lb://admin
2. user       → lb://user
3. search     → lb://search
4. manage     → lb://manage
5. news       → lb://news
6. sms        → lb://sms
7. atlas      → lb://atlas
8. ipr        → lb://ipr
9. sale       → lb://sale
```

### 1.2 cloud-demo 项目实际的服务

```
cloud-demo/
├── gateway/           ← Gateway 网关
├── user-service/      ← 用户服务
├── order-service/     ← 订单服务
├── eureka-server/     ← Eureka 注册中心
├── feign-api/         ← Feign 接口定义
└── redis-demo/        ← Redis 示例
```

**结论：cloud-demo 项目里没有 admin、search、news、sms 等服务！**

## 二、为什么会这样？

### 2.1 两种可能的情况

#### 情况 1：Nacos 配置是从其他项目复制的

```
┌─────────────────────────────────────────────────────────────────┐
│  真实的生产项目（可能是另一个项目）                               │
│                                                                 │
│  服务列表：                                                      │
│  ├── admin-service      (管理后台服务)                           │
│  ├── user-service       (用户服务)                               │
│  ├── search-service     (搜索服务)                               │
│  ├── manage-service     (管理服务)                               │
│  ├── news-service       (新闻服务)                               │
│  ├── sms-service        (短信服务)                               │
│  ├── atlas-service      (地图服务)                               │
│  ├── ipr-service        (知识产权服务)                           │
│  └── sale-service       (销售服务)                               │
│                                                                 │
│  这些服务都注册到 Nacos                                          │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 配置被复制到
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  cloud-demo 学习项目                                             │
│                                                                 │
│  Nacos 配置：gateway-dev.yaml                                    │
│  (包含了 admin、search、news 等路由配置)                          │
│                                                                 │
│  但实际服务只有：                                                │
│  ├── user-service                                               │
│  └── order-service                                              │
│                                                                 │
│  结果：配置和实际服务不匹配                                       │
└─────────────────────────────────────────────────────────────────┘
```

#### 情况 2：cloud-demo 是学习项目，只实现了部分服务

```
完整的微服务架构（设计）：
  ├── gateway
  ├── admin-service
  ├── user-service
  ├── search-service
  ├── news-service
  └── ... (其他服务)

cloud-demo 实现（简化版）：
  ├── gateway          ← 实现了
  ├── user-service     ← 实现了
  ├── order-service    ← 实现了
  └── admin-service    ← 没实现
  └── search-service   ← 没实现
  └── ... (其他服务都没实现)

Nacos 配置保留了完整的路由配置，但实际只有部分服务在运行
```

## 三、实际的服务注册和路由关系

### 3.1 cloud-demo 项目实际能工作的路由

```
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册中心                                              │
│                                                                 │
│  实际注册的服务：                                                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：gateway                                           │ │
│  │ 实例：localhost:10010                                     │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：userservice                                       │ │
│  │ 实例：localhost:8081                                      │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：orderservice                                      │ │
│  │ 实例：localhost:8082                                      │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ❌ 没有注册的服务：                                             │
│     - admin                                                     │
│     - search                                                    │
│     - news                                                      │
│     - sms                                                       │
│     - atlas                                                     │
│     - ipr                                                       │
│     - sale                                                      │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 实际能工作的请求

```
✅ 能工作的请求：

1. GET http://localhost:10010/user/1
   Gateway → 查询 Nacos → 找到 userservice → 转发成功

2. GET http://localhost:10010/order/101
   Gateway → 查询 Nacos → 找到 orderservice → 转发成功

❌ 不能工作的请求：

1. GET http://localhost:10010/admin/login
   Gateway → 查询 Nacos → 找不到 admin 服务 → 返回 503 Service Unavailable

2. GET http://localhost:10010/search/query
   Gateway → 查询 Nacos → 找不到 search 服务 → 返回 503 Service Unavailable

3. GET http://localhost:10010/news/list
   Gateway → 查询 Nacos → 找不到 news 服务 → 返回 503 Service Unavailable
```

## 四、完整的流程图（实际情况）

### 4.1 成功的请求流程（/user/1）

```
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│  请求：GET http://localhost:10010/user/1                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ① 接收请求：/user/1                                             │
│  ② 匹配路由：Path=/user/** → lb://userservice                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ③ 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册中心                                              │
│                                                                 │
│  Gateway 查询：userservice 有哪些实例？                          │
│  Nacos 返回：✅ 找到了！                                         │
│    - localhost:8081                                             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ④ 返回实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ⑤ 选择实例：localhost:8081                                      │
│  ⑥ 转发请求：http://localhost:8081/user/1                       │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑦ 转发请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  UserService (localhost:8081)                                   │
│                                                                 │
│  ⑧ 处理请求并返回：{"id":1,"name":"张三"}                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑨ 返回响应
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│  收到数据：{"id":1,"name":"张三"}                                │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 失败的请求流程（/admin/login）

```
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│  请求：POST http://localhost:10010/admin/login                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ① 接收请求：/admin/login                                        │
│  ② 匹配路由：Path=/admin/** → lb://admin                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ③ 查询服务实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册中心                                              │
│                                                                 │
│  Gateway 查询：admin 服务有哪些实例？                            │
│  Nacos 返回：❌ 没找到！admin 服务未注册                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ④ 返回空列表
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway (localhost:10010)                                      │
│                                                                 │
│  ⑤ 没有可用的服务实例                                            │
│  ⑥ 返回错误：503 Service Unavailable                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ ⑦ 返回错误
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  客户端                                                          │
│  收到错误：503 Service Unavailable                               │
│  错误信息：Unable to find instance for admin                    │
└─────────────────────────────────────────────────────────────────┘
```

## 五、服务注册的完整过程

### 5.1 UserService 如何注册到 Nacos

```
第 1 步：UserService 启动
  ┌─────────────────────────────────────────────────────────────┐
  │ UserService 应用启动                                         │
  │ 读取配置：                                                   │
  │   spring.application.name: userservice                      │
  │   spring.cloud.nacos.server-addr: localhost:8848            │
  │   server.port: 8081                                         │
  └─────────────────────────────────────────────────────────────┘

第 2 步：连接 Nacos
  ┌─────────────────────────────────────────────────────────────┐
  │ UserService → Nacos                                         │
  │ 我要注册服务！                                               │
  │   服务名：userservice                                        │
  │   IP：localhost                                             │
  │   端口：8081                                                 │
  └─────────────────────────────────────────────────────────────┘

第 3 步：Nacos 记录服务信息
  ┌─────────────────────────────────────────────────────────────┐
  │ Nacos 服务注册表                                             │
  │                                                             │
  │ userservice:                                                │
  │   - 实例 1:                                                 │
  │       IP: localhost                                         │
  │       端口: 8081                                             │
  │       状态: UP (健康)                                        │
  │       权重: 1.0                                             │
  └─────────────────────────────────────────────────────────────┘

第 4 步：定期心跳
  ┌─────────────────────────────────────────────────────────────┐
  │ UserService 每 5 秒发送心跳给 Nacos                          │
  │ UserService → Nacos：我还活着！                              │
  │ Nacos → UserService：收到，继续保持                          │
  │                                                             │
  │ 如果 15 秒没收到心跳：                                       │
  │   Nacos 标记实例为不健康                                     │
  │ 如果 30 秒没收到心跳：                                       │
  │   Nacos 删除该实例                                           │
  └─────────────────────────────────────────────────────────────┘
```

### 5.2 为什么 admin 服务找不到？

```
原因：admin-service 根本没有启动！

┌─────────────────────────────────────────────────────────────────┐
│  cloud-demo 项目目录                                             │
│                                                                 │
│  ✅ user-service/     → 有代码，可以启动，会注册到 Nacos          │
│  ✅ order-service/    → 有代码，可以启动，会注册到 Nacos          │
│  ❌ admin-service/    → 没有这个目录，没有代码，无法启动           │
│  ❌ search-service/   → 没有这个目录，没有代码，无法启动           │
│  ❌ news-service/     → 没有这个目录，没有代码，无法启动           │
└─────────────────────────────────────────────────────────────────┘

结果：
  - Gateway 配置了 admin 路由
  - 但 admin 服务不存在
  - Nacos 中没有 admin 服务的注册信息
  - 请求 /admin/** 会返回 503 错误
```

## 六、如何验证？

### 6.1 查看 Nacos 控制台

```
1. 打开浏览器访问：http://localhost:8848/nacos
2. 登录（默认账号密码：nacos/nacos）
3. 点击"服务管理" → "服务列表"
4. 查看实际注册的服务

实际看到的服务列表：
  ✅ gateway       (1 个实例)
  ✅ userservice   (1 个实例)
  ✅ orderservice  (1 个实例)
  ❌ admin         (0 个实例) ← 没有注册
  ❌ search        (0 个实例) ← 没有注册
  ❌ news          (0 个实例) ← 没有注册
```

### 6.2 测试请求

```bash
# 测试 1：访问 user 服务（应该成功）
curl http://localhost:10010/user/1

# 预期结果：
# {"id":1,"name":"张三","age":20}

# 测试 2：访问 admin 服务（应该失败）
curl http://localhost:10010/admin/login

# 预期结果：
# {
#   "timestamp": "2026-01-23T10:30:00.000+00:00",
#   "status": 503,
#   "error": "Service Unavailable",
#   "message": "Unable to find instance for admin"
# }
```

## 七、总结

### 7.1 配置和实际服务的对应关系

```
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 配置（gateway-dev.yaml）                                  │
│                                                                 │
│  配置了 9 个路由：                                               │
│  ├── admin    → lb://admin      ❌ 服务不存在                    │
│  ├── user     → lb://user       ❌ 服务不存在                    │
│  ├── search   → lb://search     ❌ 服务不存在                    │
│  ├── manage   → lb://manage     ❌ 服务不存在                    │
│  ├── news     → lb://news       ❌ 服务不存在                    │
│  ├── sms      → lb://sms        ❌ 服务不存在                    │
│  ├── atlas    → lb://atlas      ❌ 服务不存在                    │
│  ├── ipr      → lb://ipr        ❌ 服务不存在                    │
│  └── sale     → lb://sale       ❌ 服务不存在                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Gateway 本地配置（application.yml）                             │
│                                                                 │
│  配置了 2 个路由：                                               │
│  ├── user-service  → lb://userservice   ✅ 服务存在              │
│  └── order-service → lb://orderservice  ✅ 服务存在              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  cloud-demo 实际的服务                                           │
│                                                                 │
│  ✅ userservice   (localhost:8081)                              │
│  ✅ orderservice  (localhost:8082)                              │
│  ❌ admin         (不存在)                                       │
│  ❌ search        (不存在)                                       │
│  ❌ news          (不存在)                                       │
│  ❌ sms           (不存在)                                       │
│  ❌ atlas         (不存在)                                       │
│  ❌ ipr           (不存在)                                       │
│  ❌ sale          (不存在)                                       │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 一句话总结

> **Nacos 配置中的 admin、search、news 等服务在 cloud-demo 项目中并不存在**，这些配置可能是从其他项目复制过来的，或者是预留的配置。cloud-demo 实际只有 userservice 和 orderservice 两个业务服务，只有访问 `/user/**` 和 `/order/**` 的请求才能成功转发。

### 7.3 实际可用的路由

```
cloud-demo 项目中实际可用的路由：

1. /user/**   → userservice   (localhost:8081)  ✅ 可用
2. /order/**  → orderservice  (localhost:8082)  ✅ 可用

其他路由都会返回 503 错误，因为对应的服务不存在。
```
