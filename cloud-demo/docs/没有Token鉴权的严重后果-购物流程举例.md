# 没有 Token 鉴权的严重后果 - 购物流程举例

## 一、完整购物流程

### 正常流程（有 Token 鉴权）✅

```
1. 登录 → 获取 Token
2. 浏览商品 → 带 Token
3. 加入购物车 → 带 Token（知道是谁的购物车）
4. 查看购物车 → 带 Token（只能看自己的）
5. 填写收货地址 → 带 Token（只能填自己的）
6. 选择支付方式 → 带 Token
7. 提交订单 → 带 Token（知道是谁下的单）
8. 支付 → 带 Token（只能支付自己的订单）
```

---

## 二、没有 Token 鉴权会怎么样？

### 问题 1：不知道是谁在操作（最严重）

#### 场景：加入购物车

**有 Token 鉴权（正常）：**

```
客户端请求：
  POST /cart/add
  Headers:
    Authorization: Bearer eyJhbGci...  ← Token（用户 ID = 1）
  Body:
    {"productId": 100, "quantity": 2}

服务器处理：
  1. 验证 Token，获取用户 ID = 1
  2. 把商品加到用户 1 的购物车
  3. INSERT INTO cart (user_id, product_id, quantity) 
     VALUES (1, 100, 2)

结果：
  ✅ 商品加到了用户 1 的购物车
```

**没有 Token 鉴权（出问题）：**

```
客户端请求：
  POST /cart/add
  Headers: （没有 Token）
  Body:
    {"productId": 100, "quantity": 2}

服务器处理：
  1. 没有 Token，不知道是谁
  2. 把商品加到谁的购物车？？？
  3. INSERT INTO cart (user_id, product_id, quantity) 
     VALUES (?, 100, 2)  ← user_id 是多少？？？

问题：
  ❌ 不知道是谁在加购物车
  ❌ 无法保存数据
  ❌ 系统无法运行
```

---

#### 场景：查看购物车

**有 Token 鉴权（正常）：**

```
客户端请求：
  GET /cart/list
  Headers:
    Authorization: Bearer eyJhbGci...  ← Token（用户 ID = 1）

服务器处理：
  1. 验证 Token，获取用户 ID = 1
  2. 查询用户 1 的购物车
  3. SELECT * FROM cart WHERE user_id = 1

返回：
  [
    {"productId": 100, "productName": "iPhone", "quantity": 2},
    {"productId": 200, "productName": "iPad", "quantity": 1}
  ]

结果：
  ✅ 只能看到自己的购物车
```

**没有 Token 鉴权（出问题）：**

```
客户端请求：
  GET /cart/list
  Headers: （没有 Token）

服务器处理：
  1. 没有 Token，不知道是谁
  2. 查询谁的购物车？？？
  3. SELECT * FROM cart WHERE user_id = ?  ← user_id 是多少？？？

方案 A：返回所有人的购物车（泄露隐私）
  SELECT * FROM cart
  返回：
    [
      {"userId": 1, "productId": 100, "quantity": 2},  ← 张三的
      {"userId": 2, "productId": 200, "quantity": 1},  ← 李四的
      {"userId": 3, "productId": 300, "quantity": 3}   ← 王五的
    ]
  
  问题：
    ❌ 所有人的购物车都能看到
    ❌ 隐私泄露

方案 B：返回空（无法使用）
  返回：[]
  
  问题：
    ❌ 看不到自己的购物车
    ❌ 系统无法使用
```

---

### 问题 2：任何人都可以操作别人的数据

#### 场景：提交订单

**有 Token 鉴权（正常）：**

```
客户端请求：
  POST /order/create
  Headers:
    Authorization: Bearer eyJhbGci...  ← Token（用户 ID = 1）
  Body:
    {
      "productId": 100,
      "quantity": 2,
      "address": "北京市朝阳区",
      "totalPrice": 10000
    }

服务器处理：
  1. 验证 Token，获取用户 ID = 1
  2. 创建订单，订单属于用户 1
  3. INSERT INTO orders (user_id, product_id, quantity, address, total_price)
     VALUES (1, 100, 2, '北京市朝阳区', 10000)

结果：
  ✅ 订单属于用户 1
  ✅ 只有用户 1 可以查看和支付这个订单
```

**没有 Token 鉴权（出问题）：**

```
黑客请求：
  POST /order/create
  Headers: （没有 Token）
  Body:
    {
      "userId": 999,  ← 黑客随便填一个用户 ID
      "productId": 100,
      "quantity": 2,
      "address": "黑客的地址",
      "totalPrice": 1  ← 黑客把价格改成 1 元
    }

服务器处理：
  1. 没有 Token，不验证身份
  2. 直接相信客户端传来的 userId
  3. INSERT INTO orders (user_id, product_id, quantity, address, total_price)
     VALUES (999, 100, 2, '黑客的地址', 1)  ← 直接用客户端传来的数据

问题：
  ❌ 黑客可以冒充任何用户下单
  ❌ 黑客可以把价格改成 1 元
  ❌ 黑客可以把商品发到自己的地址
  ❌ 商家损失惨重
```

---

#### 场景：支付订单

**有 Token 鉴权（正常）：**

```
客户端请求：
  POST /order/pay
  Headers:
    Authorization: Bearer eyJhbGci...  ← Token（用户 ID = 1）
  Body:
    {"orderId": 12345}

服务器处理：
  1. 验证 Token，获取用户 ID = 1
  2. 查询订单：SELECT * FROM orders WHERE id = 12345
  3. 检查：订单是不是属于用户 1？
     if (order.userId != 1) {
         return "无权支付别人的订单";
     }
  4. 扣款，更新订单状态

结果：
  ✅ 只能支付自己的订单
  ✅ 无法支付别人的订单
```

**没有 Token 鉴权（出问题）：**

```
黑客请求：
  POST /order/pay
  Headers: （没有 Token）
  Body:
    {"orderId": 12345, "userId": 1}  ← 黑客随便填一个用户 ID

服务器处理：
  1. 没有 Token，不验证身份
  2. 直接相信客户端传来的 userId
  3. 查询订单：SELECT * FROM orders WHERE id = 12345
  4. 不检查订单是否属于该用户
  5. 直接扣款，更新订单状态

问题：
  ❌ 黑客可以支付别人的订单
  ❌ 张三的订单，李四来支付
  ❌ 李四的钱被扣了，张三收到了货
  ❌ 系统混乱
```

---

### 问题 3：黑客可以篡改数据

#### 场景：修改订单金额

**有 Token 鉴权（正常）：**

```
客户端请求：
  PUT /order/update
  Headers:
    Authorization: Bearer eyJhbGci...  ← Token（用户 ID = 1）
  Body:
    {
      "orderId": 12345,
      "totalPrice": 5000  ← 想把 10000 改成 5000
    }

服务器处理：
  1. 验证 Token，获取用户 ID = 1
  2. 查询订单：SELECT * FROM orders WHERE id = 12345
  3. 检查：订单是不是属于用户 1？
  4. 检查：用户是否有权限修改价格？
     if (!user.isAdmin()) {
         return "普通用户无权修改价格";
     }
  5. 拒绝修改

结果：
  ✅ 普通用户无法修改价格
  ✅ 只有管理员可以修改
```

**没有 Token 鉴权（出问题）：**

```
黑客请求：
  PUT /order/update
  Headers: （没有 Token）
  Body:
    {
      "orderId": 12345,
      "totalPrice": 1  ← 黑客把 10000 改成 1
    }

服务器处理：
  1. 没有 Token，不验证身份
  2. 不检查权限
  3. 直接更新：UPDATE orders SET total_price = 1 WHERE id = 12345

问题：
  ❌ 黑客可以把价格改成 1 元
  ❌ 原价 10000 的商品，1 元就买到了
  ❌ 商家损失惨重
```

---

## 三、完整购物流程对比

### 有 Token 鉴权（正常）✅

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：登录                                                   │
│                                                                 │
│  POST /user/login                                               │
│  Body: {"username":"张三","password":"123456"}                  │
│                                                                 │
│  返回：{"token":"eyJhbGci...","userId":1}                       │
│  客户端保存 Token                                                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：浏览商品                                               │
│                                                                 │
│  GET /product/list                                              │
│  Headers: Authorization: Bearer eyJhbGci...                     │
│                                                                 │
│  返回：商品列表                                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：加入购物车                                             │
│                                                                 │
│  POST /cart/add                                                 │
│  Headers: Authorization: Bearer eyJhbGci...  ← Token（用户 1）  │
│  Body: {"productId":100,"quantity":2}                           │
│                                                                 │
│  服务器：                                                        │
│    1. 验证 Token，获取用户 ID = 1                               │
│    2. 把商品加到用户 1 的购物车                                  │
│    3. INSERT INTO cart (user_id, product_id, quantity)          │
│       VALUES (1, 100, 2)                                        │
│                                                                 │
│  返回：加入成功 ✅                                               │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：查看购物车                                             │
│                                                                 │
│  GET /cart/list                                                 │
│  Headers: Authorization: Bearer eyJhbGci...  ← Token（用户 1）  │
│                                                                 │
│  服务器：                                                        │
│    1. 验证 Token，获取用户 ID = 1                               │
│    2. 查询用户 1 的购物车                                        │
│    3. SELECT * FROM cart WHERE user_id = 1                      │
│                                                                 │
│  返回：用户 1 的购物车 ✅                                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 5 步：提交订单                                               │
│                                                                 │
│  POST /order/create                                             │
│  Headers: Authorization: Bearer eyJhbGci...  ← Token（用户 1）  │
│  Body: {"productId":100,"quantity":2,"address":"北京"}          │
│                                                                 │
│  服务器：                                                        │
│    1. 验证 Token，获取用户 ID = 1                               │
│    2. 创建订单，订单属于用户 1                                   │
│    3. INSERT INTO orders (user_id, product_id, ...)             │
│       VALUES (1, 100, ...)                                      │
│                                                                 │
│  返回：订单创建成功，订单号 12345 ✅                             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 6 步：支付订单                                               │
│                                                                 │
│  POST /order/pay                                                │
│  Headers: Authorization: Bearer eyJhbGci...  ← Token（用户 1）  │
│  Body: {"orderId":12345}                                        │
│                                                                 │
│  服务器：                                                        │
│    1. 验证 Token，获取用户 ID = 1                               │
│    2. 查询订单：SELECT * FROM orders WHERE id = 12345           │
│    3. 检查：订单是否属于用户 1？✅                               │
│    4. 扣款，更新订单状态                                         │
│                                                                 │
│  返回：支付成功 ✅                                               │
└─────────────────────────────────────────────────────────────────┘
```

**结果：**
- ✅ 每一步都知道是谁在操作
- ✅ 只能操作自己的数据
- ✅ 无法操作别人的数据
- ✅ 系统安全可靠

---

### 没有 Token 鉴权（出问题）❌

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：浏览商品                                               │
│                                                                 │
│  GET /product/list                                              │
│  Headers: （没有 Token）                                        │
│                                                                 │
│  返回：商品列表                                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：加入购物车                                             │
│                                                                 │
│  POST /cart/add                                                 │
│  Headers: （没有 Token）                                        │
│  Body: {"userId":1,"productId":100,"quantity":2}  ← 黑客随便填  │
│                                                                 │
│  服务器：                                                        │
│    1. 没有 Token，不知道是谁                                    │
│    2. 直接相信客户端传来的 userId = 1                           │
│    3. INSERT INTO cart (user_id, product_id, quantity)          │
│       VALUES (1, 100, 2)  ← 用客户端传来的 userId               │
│                                                                 │
│  问题：                                                          │
│    ❌ 黑客可以冒充任何用户                                       │
│    ❌ 黑客可以把商品加到别人的购物车                             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：查看购物车                                             │
│                                                                 │
│  GET /cart/list?userId=1  ← 黑客随便填一个 userId               │
│  Headers: （没有 Token）                                        │
│                                                                 │
│  服务器：                                                        │
│    1. 没有 Token，不知道是谁                                    │
│    2. 直接相信客户端传来的 userId = 1                           │
│    3. SELECT * FROM cart WHERE user_id = 1                      │
│                                                                 │
│  问题：                                                          │
│    ❌ 黑客可以查看任何人的购物车                                 │
│    ❌ 隐私泄露                                                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：提交订单                                               │
│                                                                 │
│  POST /order/create                                             │
│  Headers: （没有 Token）                                        │
│  Body: {                                                        │
│    "userId":1,  ← 黑客冒充用户 1                                │
│    "productId":100,                                             │
│    "quantity":2,                                                │
│    "address":"黑客的地址",  ← 黑客填自己的地址                  │
│    "totalPrice":1  ← 黑客把价格改成 1 元                        │
│  }                                                              │
│                                                                 │
│  服务器：                                                        │
│    1. 没有 Token，不知道是谁                                    │
│    2. 直接相信客户端传来的数据                                   │
│    3. INSERT INTO orders (user_id, product_id, address, total_price)│
│       VALUES (1, 100, '黑客的地址', 1)                          │
│                                                                 │
│  问题：                                                          │
│    ❌ 黑客冒充用户 1 下单                                        │
│    ❌ 黑客把价格改成 1 元                                        │
│    ❌ 黑客把商品发到自己的地址                                   │
│    ❌ 用户 1 被扣款，黑客收到货                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 5 步：支付订单                                               │
│                                                                 │
│  POST /order/pay                                                │
│  Headers: （没有 Token）                                        │
│  Body: {"orderId":12345,"userId":1}  ← 黑客随便填               │
│                                                                 │
│  服务器：                                                        │
│    1. 没有 Token，不知道是谁                                    │
│    2. 直接相信客户端传来的 userId = 1                           │
│    3. 扣用户 1 的钱                                              │
│    4. 更新订单状态                                               │
│                                                                 │
│  问题：                                                          │
│    ❌ 黑客可以用别人的钱支付                                     │
│    ❌ 用户 1 的钱被扣了，黑客收到货                              │
└─────────────────────────────────────────────────────────────────┘
```

**结果：**
- ❌ 不知道是谁在操作
- ❌ 黑客可以冒充任何用户
- ❌ 黑客可以篡改数据（价格、地址等）
- ❌ 黑客可以查看别人的数据
- ❌ 系统完全不安全

---

## 四、真实案例

### 案例 1：1 元购买 iPhone

```
正常流程：
  1. 用户选择 iPhone（价格 10000 元）
  2. 提交订单
  3. 服务器创建订单，价格 10000 元
  4. 用户支付 10000 元

没有 Token 鉴权：
  1. 黑客选择 iPhone（价格 10000 元）
  2. 黑客抓包，修改请求：
     POST /order/create
     Body: {
       "productId": 100,
       "totalPrice": 1  ← 改成 1 元
     }
  3. 服务器直接相信客户端传来的价格
  4. 创建订单，价格 1 元
  5. 黑客支付 1 元
  6. 黑客收到 iPhone

结果：
  ❌ 黑客用 1 元买到了 10000 元的 iPhone
  ❌ 商家损失 9999 元
```

---

### 案例 2：查看别人的订单

```
正常流程：
  1. 用户登录，获取 Token
  2. 查看自己的订单
  3. 只能看到自己的订单

没有 Token 鉴权：
  1. 黑客不登录
  2. 黑客遍历订单 ID：
     GET /order/detail?orderId=1
     GET /order/detail?orderId=2
     GET /order/detail?orderId=3
     ...
  3. 服务器返回所有订单的详情
  4. 黑客看到了所有人的订单信息：
     - 姓名、电话、地址
     - 购买的商品
     - 支付金额

结果：
  ❌ 所有用户的隐私泄露
  ❌ 黑客可以进行诈骗、骚扰
```

---

### 案例 3：用别人的钱支付

```
正常流程：
  1. 张三下单，订单号 12345
  2. 张三支付，扣张三的钱
  3. 张三收到货

没有 Token 鉴权：
  1. 张三下单，订单号 12345
  2. 黑客知道了订单号
  3. 黑客发送请求：
     POST /order/pay
     Body: {
       "orderId": 12345,
       "userId": 999  ← 黑客填李四的 ID
     }
  4. 服务器直接相信客户端传来的 userId
  5. 扣李四的钱
  6. 张三收到货

结果：
  ❌ 李四的钱被扣了
  ❌ 张三收到了货
  ❌ 系统混乱
```

---

## 五、总结

### 没有 Token 鉴权的严重后果

```
1. 不知道是谁在操作
   - 无法保存数据（不知道是谁的购物车、订单）
   - 系统无法运行

2. 黑客可以冒充任何用户
   - 冒充张三下单
   - 冒充李四支付
   - 冒充王五查看订单

3. 黑客可以篡改数据
   - 把价格改成 1 元
   - 把地址改成自己的
   - 把数量改成 999

4. 黑客可以查看别人的数据
   - 查看别人的购物车
   - 查看别人的订单
   - 查看别人的地址、电话

5. 商家损失惨重
   - 黑客 1 元买 iPhone
   - 黑客用别人的钱支付
   - 黑客把商品发到自己的地址
```

### 一句话总结

**没有 Token 鉴权，就像银行不检查身份证，任何人都可以取任何人的钱，黑客可以冒充任何用户操作，可以篡改价格、地址等数据，可以查看别人的隐私信息，系统完全不安全，商家损失惨重！**

### 购物流程必须有 Token 鉴权

```
每一步都需要 Token：
  1. 浏览商品 → 可以不需要 Token（公开信息）
  2. 加入购物车 → 必须有 Token（知道是谁的购物车）
  3. 查看购物车 → 必须有 Token（只能看自己的）
  4. 提交订单 → 必须有 Token（知道是谁下的单）
  5. 支付订单 → 必须有 Token（只能支付自己的订单）

没有 Token = 系统崩溃 + 商家破产 + 用户隐私泄露
```
