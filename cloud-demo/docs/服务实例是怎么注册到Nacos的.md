# 服务实例是怎么注册到 Nacos 的

## 一、核心问题

**问题：** Gateway 查询 Nacos 时，Nacos 返回的服务实例（如 172.16.1.100:8080）是怎么来的？

**答案：** 服务启动时，自己主动注册到 Nacos 的！

## 二、服务注册的完整流程

### 2.1 以 UserService 为例

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：开发人员启动 UserService                                │
│                                                                 │
│  命令：java -jar user-service.jar                                │
│  或者：在 IDEA 中点击运行按钮                                     │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：UserService 读取配置文件                                │
│                                                                 │
│  application.yml:                                               │
│    server:                                                      │
│      port: 8081                    ← 我的端口是 8081            │
│    spring:                                                      │
│      application:                                               │
│        name: userservice           ← 我的服务名是 userservice   │
│      cloud:                                                     │
│        nacos:                                                   │
│          server-addr: localhost:8848  ← Nacos 地址             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：UserService 启动完成，准备注册                          │
│                                                                 │
│  UserService 内部：                                              │
│    我启动完成了！                                                │
│    我的 IP 是：192.168.1.100 (自动获取本机 IP)                   │
│    我的端口是：8081 (从配置读取)                                 │
│    我的服务名是：userservice (从配置读取)                         │
│    我要去 Nacos 注册！                                           │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 发送注册请求
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：UserService 向 Nacos 发送注册请求                       │
│                                                                 │
│  HTTP 请求：                                                     │
│    POST http://localhost:8848/nacos/v1/ns/instance              │
│    参数：                                                        │
│      serviceName: userservice                                   │
│      ip: 192.168.1.100                                          │
│      port: 8081                                                 │
│      weight: 1.0                                                │
│      healthy: true                                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 5 步：Nacos 接收注册请求并保存                                │
│                                                                 │
│  Nacos 服务注册表：                                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 服务名：userservice                                       │ │
│  │ 实例列表：                                                 │ │
│  │   - 实例 1:                                               │ │
│  │       IP: 192.168.1.100                                   │ │
│  │       端口: 8081                                           │ │
│  │       状态: UP (健康)                                      │ │
│  │       权重: 1.0                                           │ │
│  │       注册时间: 2026-01-23 10:30:00                       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  Nacos → UserService：注册成功！                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 6 步：UserService 定期发送心跳                                │
│                                                                 │
│  每 5 秒发送一次心跳：                                           │
│    UserService → Nacos：我还活着！                               │
│    Nacos → UserService：收到，继续保持                           │
│                                                                 │
│  如果 Nacos 15 秒没收到心跳：                                    │
│    标记实例为不健康 (healthy: false)                             │
│                                                                 │
│  如果 Nacos 30 秒没收到心跳：                                    │
│    从注册表中删除该实例                                          │
└─────────────────────────────────────────────────────────────────┘
```

## 三、多实例注册的情况

### 3.1 启动多个 UserService 实例

```
场景：为了负载均衡，启动 3 个 UserService 实例

┌─────────────────────────────────────────────────────────────────┐
│  实例 1：在服务器 A 上启动                                        │
│                                                                 │
│  java -jar user-service.jar --server.port=8081                  │
│                                                                 │
│  配置：                                                          │
│    IP: 192.168.1.100 (服务器 A 的 IP)                           │
│    端口: 8081                                                    │
│    服务名: userservice                                           │
│                                                                 │
│  注册到 Nacos →                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  实例 2：在服务器 B 上启动                                        │
│                                                                 │
│  java -jar user-service.jar --server.port=8081                  │
│                                                                 │
│  配置：                                                          │
│    IP: 192.168.1.101 (服务器 B 的 IP)                           │
│    端口: 8081                                                    │
│    服务名: userservice                                           │
│                                                                 │
│  注册到 Nacos →                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  实例 3：在服务器 C 上启动                                        │
│                                                                 │
│  java -jar user-service.jar --server.port=8081                  │
│                                                                 │
│  配置：                                                          │
│    IP: 192.168.1.102 (服务器 C 的 IP)                           │
│    端口: 8081                                                    │
│    服务名: userservice                                           │
│                                                                 │
│  注册到 Nacos →                                                  │
└─────────────────────────────────────────────────────────────────┘

                            ↓
                            
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册表                                                │
│                                                                 │
│  服务名：userservice                                             │
│  实例列表：                                                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 实例 1:                                                   │ │
│  │   IP: 192.168.1.100                                       │ │
│  │   端口: 8081                                               │ │
│  │   状态: UP                                                 │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 实例 2:                                                   │ │
│  │   IP: 192.168.1.101                                       │ │
│  │   端口: 8081                                               │ │
│  │   状态: UP                                                 │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 实例 3:                                                   │ │
│  │   IP: 192.168.1.102                                       │ │
│  │   端口: 8081                                               │ │
│  │   状态: UP                                                 │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 四、Gateway 查询服务实例的过程

### 4.1 完整流程

```
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：Gateway 收到请求                                        │
│                                                                 │
│  请求：GET http://localhost:10010/user/1                        │
│  匹配路由：lb://userservice                                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 需要查询 userservice 的实例
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：Gateway 向 Nacos 查询                                   │
│                                                                 │
│  HTTP 请求：                                                     │
│    GET http://localhost:8848/nacos/v1/ns/instance/list          │
│    参数：                                                        │
│      serviceName: userservice                                   │
│      healthyOnly: true  (只要健康的实例)                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：Nacos 查询注册表                                        │
│                                                                 │
│  Nacos 内部：                                                    │
│    1. 查找服务名为 userservice 的记录                            │
│    2. 过滤出健康的实例 (healthy: true)                           │
│    3. 返回实例列表                                               │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：Nacos 返回实例列表                                      │
│                                                                 │
│  响应 JSON：                                                     │
│  {                                                              │
│    "hosts": [                                                   │
│      {                                                          │
│        "ip": "192.168.1.100",                                   │
│        "port": 8081,                                            │
│        "weight": 1.0,                                           │
│        "healthy": true                                          │
│      },                                                         │
│      {                                                          │
│        "ip": "192.168.1.101",                                   │
│        "port": 8081,                                            │
│        "weight": 1.0,                                           │
│        "healthy": true                                          │
│      },                                                         │
│      {                                                          │
│        "ip": "192.168.1.102",                                   │
│        "port": 8081,                                            │
│        "weight": 1.0,                                           │
│        "healthy": true                                          │
│      }                                                          │
│    ]                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 5 步：Gateway 使用负载均衡算法选择一个实例                     │
│                                                                 │
│  实例列表：                                                      │
│    - 192.168.1.100:8081                                         │
│    - 192.168.1.101:8081                                         │
│    - 192.168.1.102:8081                                         │
│                                                                 │
│  轮询算法：                                                      │
│    本次选择：192.168.1.100:8081                                  │
│    下次选择：192.168.1.101:8081                                  │
│    再下次：192.168.1.102:8081                                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第 6 步：Gateway 转发请求                                        │
│                                                                 │
│  转发到：http://192.168.1.100:8081/user/1                        │
└─────────────────────────────────────────────────────────────────┘
```

## 五、cloud-demo 项目的实际情况

### 5.1 实际注册的服务

```
┌─────────────────────────────────────────────────────────────────┐
│  启动 UserService                                                │
│                                                                 │
│  在 IDEA 中运行 UserApplication.java                             │
│  或者：java -jar user-service.jar                                │
│                                                                 │
│  配置：                                                          │
│    server.port: 8081                                            │
│    spring.application.name: userservice                         │
│    spring.cloud.nacos.server-addr: localhost:8848               │
│                                                                 │
│  启动后自动注册到 Nacos                                          │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 服务注册表（实际情况）                                     │
│                                                                 │
│  服务名：userservice                                             │
│  实例列表：                                                      │
│    - IP: localhost (或 127.0.0.1)                               │
│      端口: 8081                                                  │
│      状态: UP                                                    │
│                                                                 │
│  服务名：orderservice                                            │
│  实例列表：                                                      │
│    - IP: localhost (或 127.0.0.1)                               │
│      端口: 8082                                                  │
│      状态: UP                                                    │
│                                                                 │
│  服务名：gateway                                                 │
│  实例列表：                                                      │
│    - IP: localhost (或 127.0.0.1)                               │
│      端口: 10010                                                 │
│      状态: UP                                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 如果查询不存在的服务

```
┌─────────────────────────────────────────────────────────────────┐
│  Gateway 收到请求：POST /admin/login                             │
│  匹配路由：lb://admin                                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 查询 admin 服务
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway → Nacos：admin 服务有哪些实例？                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 查询注册表                                                │
│                                                                 │
│  查找服务名：admin                                               │
│  结果：❌ 没找到！                                               │
│                                                                 │
│  原因：没有任何 admin-service 启动并注册                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 返回空列表
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Nacos → Gateway：                                               │
│                                                                 │
│  响应 JSON：                                                     │
│  {                                                              │
│    "hosts": []  ← 空数组，没有实例                               │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  Gateway 处理                                                    │
│                                                                 │
│  实例列表为空！                                                  │
│  无法转发请求                                                    │
│  返回错误：503 Service Unavailable                               │
│  错误信息：Unable to find instance for admin                    │
└─────────────────────────────────────────────────────────────────┘
```

## 六、如何查看 Nacos 中注册的服务

### 6.1 通过 Nacos 控制台查看

```
步骤 1：打开浏览器
  访问：http://localhost:8848/nacos

步骤 2：登录
  账号：nacos
  密码：nacos

步骤 3：查看服务列表
  点击左侧菜单："服务管理" → "服务列表"

步骤 4：查看实例详情
  点击服务名（如 userservice）
  可以看到：
    - 实例 IP
    - 实例端口
    - 健康状态
    - 权重
    - 元数据
```

### 6.2 实际看到的内容（cloud-demo）

```
┌─────────────────────────────────────────────────────────────────┐
│  Nacos 控制台 - 服务列表                                         │
│                                                                 │
│  ┌──────────────┬──────────┬──────────┬──────────────────────┐ │
│  │ 服务名        │ 分组     │ 实例数   │ 健康实例数            │ │
│  ├──────────────┼──────────┼──────────┼──────────────────────┤ │
│  │ gateway      │ DEFAULT  │ 1        │ 1                    │ │
│  │ userservice  │ DEFAULT  │ 1        │ 1                    │ │
│  │ orderservice │ DEFAULT  │ 1        │ 1                    │ │
│  └──────────────┴──────────┴──────────┴──────────────────────┘ │
│                                                                 │
│  点击 userservice 查看详情：                                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ IP: 127.0.0.1                                             │ │
│  │ 端口: 8081                                                 │ │
│  │ 权重: 1.0                                                  │ │
│  │ 健康: ✅ 是                                                │ │
│  │ 集群: DEFAULT                                              │ │
│  │ 元数据: {}                                                 │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 七、服务注册的代码实现

### 7.1 UserService 的配置

```yaml
# user-service/src/main/resources/application.yml

server:
  port: 8081  # 服务端口

spring:
  application:
    name: userservice  # 服务名，注册到 Nacos 时使用
  cloud:
    nacos:
      server-addr: localhost:8848  # Nacos 地址
      discovery:
        cluster-name: SH  # 集群名称（可选）
```

### 7.2 UserService 的启动类

```java
package cn.itcast.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class UserApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserApplication.class, args);
    }
}
```

**关键点：**
- 只要添加了 `spring-cloud-starter-alibaba-nacos-discovery` 依赖
- 配置了 `spring.cloud.nacos.server-addr`
- 服务启动时就会**自动注册**到 Nacos

### 7.3 自动注册的原理

```
服务启动
    ↓
Spring Boot 自动配置
    ↓
检测到 Nacos Discovery 依赖
    ↓
创建 NacosServiceRegistry Bean
    ↓
读取配置：
  - spring.application.name
  - spring.cloud.nacos.server-addr
  - server.port
    ↓
获取本机 IP
    ↓
构建注册信息：
  - serviceName: userservice
  - ip: 192.168.1.100
  - port: 8081
    ↓
发送注册请求到 Nacos
    ↓
启动心跳任务（每 5 秒发送一次）
    ↓
注册完成
```

## 八、总结

### 8.1 服务实例的来源

```
服务实例的 IP 和端口是怎么来的？

1. 服务自己启动时注册的
   ├─ IP：服务自动获取本机 IP
   └─ 端口：从配置文件读取 (server.port)

2. 注册到 Nacos
   ├─ 服务名：spring.application.name
   ├─ IP：自动获取
   └─ 端口：server.port

3. Gateway 查询时
   ├─ Gateway 向 Nacos 查询服务名
   └─ Nacos 返回所有注册的实例
```

### 8.2 为什么文档中的 IP 是 172.16.1.100？

```
那是我假设的示例 IP！

实际情况：
  - 如果在本地开发：IP 是 localhost 或 127.0.0.1
  - 如果在服务器部署：IP 是服务器的实际 IP

cloud-demo 项目实际情况：
  - userservice: localhost:8081
  - orderservice: localhost:8082
  - gateway: localhost:10010
```

### 8.3 一句话总结

> **服务实例的 IP 和端口是服务启动时自己注册到 Nacos 的**，Gateway 查询 Nacos 时，Nacos 返回所有已注册的健康实例列表。如果服务没有启动，Nacos 就没有该服务的实例信息，Gateway 查询时会得到空列表，返回 503 错误。
