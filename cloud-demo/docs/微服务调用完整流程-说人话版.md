# 微服务调用完整流程 - 说人话版

## 一、OrderService 是干啥的

**查订单，顺便把下单用户的信息也查出来。**

---

## 二、怎么访问

```
http://localhost:8080/order/101
```

**返回：**
```json
{
  "id": 101,
  "name": "iPhone 12",
  "price": 699900,
  "user": {
    "id": 1,
    "username": "柳岩",
    "address": "湖南长沙"
  }
}
```

---

## 三、和 UserService 啥关系

**OrderService 要查用户信息，自己没有，就去问 UserService 要。**

---

## 四、完整流程（说人话）

### 第1步：你访问订单接口

```
你在浏览器输入：
http://localhost:8080/order/101
```

---

### 第2步：OrderService 查订单

```
OrderService 收到请求
  ↓
查自己的数据库（cloud_order）
  ↓
SQL: SELECT * FROM tb_order WHERE id = 101
  ↓
查到：
  订单ID: 101
  用户ID: 1
  商品: iPhone 12
  价格: 699900
```

---

### 第3步：OrderService 发现需要用户信息

```
OrderService 想：
"订单是用户 1 下的，但我不知道用户 1 是谁"
"我得去问 UserService"
```

---

### 第4步：OrderService 调用 UserService

```java
// OrderService 代码
User user = userClient.findById(1);
```

**这行代码背后发生了什么：**

#### 4.1 Feign 拦截调用
```
Feign 发现：
- 接口上有 @FeignClient("userservice")
- 要调用的服务名是 "userservice"
- 要调用的路径是 /user/1
```

#### 4.2 Feign 问 Nacos 要地址
```
Feign: "Nacos，userservice 在哪？"

Nacos: "我查查注册表..."
  ↓
Nacos: "找到了！userservice 在 192.168.26.1:8081"
```

**Nacos 怎么知道的？**
```
UserService 启动时：
  ↓
读取配置 application.yml
  - 服务名: userservice
  - 端口: 8081
  - Nacos 地址: localhost:8848
  ↓
自动获取本机 IP: 192.168.26.1
  ↓
连接 Nacos，发送注册请求：
  "我是 userservice，地址是 192.168.26.1:8081"
  ↓
Nacos 记录：
  userservice → 192.168.26.1:8081
```

#### 4.3 Feign 发 HTTP 请求
```
Feign 构建请求：
  GET http://192.168.26.1:8081/user/1
  ↓
发送请求
```

---

### 第5步：UserService 处理请求

```
UserService 收到请求：
  GET /user/1
  ↓
查自己的数据库（cloud_user）
  ↓
SQL: SELECT * FROM tb_user WHERE id = 1
  ↓
查到：
  用户ID: 1
  用户名: 柳岩
  地址: 湖南长沙
  ↓
返回 JSON：
  {"id":1, "username":"柳岩", "address":"湖南长沙"}
```

---

### 第6步：OrderService 收到用户信息

```
Feign 收到响应：
  {"id":1, "username":"柳岩", "address":"湖南长沙"}
  ↓
Feign 自动转成对象：
  User user = new User();
  user.setId(1);
  user.setUsername("柳岩");
  user.setAddress("湖南长沙");
  ↓
返回给 OrderService
```

---

### 第7步：OrderService 拼装数据

```java
// OrderService 代码
order.setUser(user);  // 把用户信息塞到订单里
return order;         // 返回完整订单
```

---

### 第8步：返回给你

```json
{
  "id": 101,
  "name": "iPhone 12",
  "price": 699900,
  "user": {
    "id": 1,
    "username": "柳岩",
    "address": "湖南长沙"
  }
}
```

---

## 五、画个图（完整流程）

```
你的浏览器
    ↓
http://localhost:8080/order/101
    ↓
OrderService (8080端口)
    ↓
① 查订单表
   SELECT * FROM tb_order WHERE id = 101
   得到：订单 101，用户ID=1
    ↓
② 调用 UserService
   userClient.findById(1)
    ↓
③ Feign 拦截
   发现要调用 "userservice"
    ↓
④ Feign 问 Nacos
   "userservice 在哪？"
    ↓
⑤ Nacos 返回地址
   "192.168.26.1:8081"
    ↓
⑥ Feign 发请求
   GET http://192.168.26.1:8081/user/1
    ↓
UserService (8081端口)
    ↓
⑦ 查用户表
   SELECT * FROM tb_user WHERE id = 1
   得到：用户 1，柳岩，湖南长沙
    ↓
⑧ 返回 JSON
   {"id":1, "username":"柳岩"}
    ↓
⑨ Feign 转成对象
   User user = ...
    ↓
⑩ OrderService 拼装
   order.setUser(user)
    ↓
⑪ 返回给你
   完整订单 + 用户信息
```

---

## 六、关键角色

### 1. OrderService (8080)
**职责：** 查订单，调用其他服务获取额外信息

**配置：**
```yaml
server:
  port: 8080
spring:
  application:
    name: orderservice
  datasource:
    url: jdbc:mysql://localhost:3306/cloud_order
  cloud:
    nacos:
      server-addr: localhost:8848
```

---

### 2. UserService (8081)
**职责：** 提供用户信息

**配置：**
```yaml
server:
  port: 8081
spring:
  application:
    name: userservice
  datasource:
    url: jdbc:mysql://localhost:3306/cloud_user
  cloud:
    nacos:
      server-addr: localhost:8848
```

---

### 3. Nacos (8848)
**职责：** 记录所有服务的地址（通讯录）

**记录内容：**
```
orderservice → 192.168.26.1:8080
userservice  → 192.168.26.1:8081
```

**访问：** `http://localhost:8848/nacos`

---

### 4. Feign
**职责：** 远程调用工具（打电话的人）

**使用方式：**
```java
// 定义接口
@FeignClient("userservice")
public interface UserClient {
    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}

// 使用（像调本地方法一样）
User user = userClient.findById(1);
```

---

## 七、IP 地址的来源

### 问题：192.168.26.1 哪来的？

**答：你电脑的 IP，自动获取的。**

---

### 详细说明

#### 你的电脑
```
查看 IP：
  Windows: ipconfig
  Mac/Linux: ifconfig

输出：
  IPv4 地址: 192.168.26.1
```

#### 服务启动时
```
OrderService 启动
  ↓
Spring Boot 自动获取本机 IP
  InetAddress.getLocalHost().getHostAddress()
  ↓
得到：192.168.26.1
  ↓
注册到 Nacos：
  orderservice → 192.168.26.1:8080
```

---

### 端口哪来的

**配置文件里写的：**

```yaml
# OrderService
server:
  port: 8080  # ← 这里

# UserService
server:
  port: 8081  # ← 这里
```

---

### 完整地址

```
IP（自动获取） + 端口（配置文件）
  ↓
192.168.26.1:8080 (OrderService)
192.168.26.1:8081 (UserService)
```

---

## 八、为什么要这么搞

### 问题1：为啥不直接查用户表？

**答：** 订单服务连的是 `cloud_order` 数据库，用户表在 `cloud_user` 数据库，查不到。

---

### 问题2：为啥不把两个表放一个库？

**答：** 微服务架构，每个服务管自己的数据库。

**好处：**
- 解耦：改用户逻辑不影响订单
- 扩展：订单压力大，单独加机器
- 维护：用户服务挂了，订单服务还能查订单（只是没用户信息）

---

### 问题3：为啥要用 Nacos？

**没有 Nacos：**
```java
// 写死地址
String url = "http://192.168.26.1:8081/user/1";
User user = restTemplate.getForObject(url, User.class);

问题：
- UserService 换机器，代码要改
- UserService 加机器，代码要改
- UserService 挂了，不知道
```

**有 Nacos：**
```java
// 只写服务名
@FeignClient("userservice")
User user = userClient.findById(1);

好处：
- UserService 换机器，自动更新
- UserService 加机器，自动发现
- UserService 挂了，自动剔除
```

---

## 九、配置文件的作用

### bootstrap.yml（先加载）

```yaml
spring:
  application:
    name: userservice  # 服务名
  cloud:
    nacos:
      server-addr: localhost:8848  # Nacos 地址
      config:
        enabled: true  # 启用配置中心
      discovery:
        cluster-name: SH  # 集群名
```

**作用：**
1. 连接 Nacos
2. 下载远程配置
3. 注册服务

---

### application.yml（后加载）

```yaml
server:
  port: 8081  # 端口

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/cloud_user
    username: root
    password: root
```

**作用：**
1. 配置端口
2. 配置数据库
3. 配置本地参数

---

## 十、Nacos 控制台

### 访问地址
```
http://localhost:8848/nacos
用户名: nacos
密码: nacos
```

---

### 服务列表

```
服务名          实例数    健康实例
orderservice    1         1
userservice     1         1
```

---

### 服务详情（orderservice）

```
IP              端口    集群    健康状态
192.168.26.1    8080    HZ      健康
```

---

### 服务详情（userservice）

```
IP              端口    集群    健康状态
192.168.26.1    8081    SH      健康
```

---

## 十一、整体流程（一句话版）

**你访问 OrderService 查订单，OrderService 发现需要用户信息，通过 Feign 问 Nacos 要 UserService 的地址，然后调用 UserService 查用户，最后把订单 + 用户信息一起返回给你。**

---

## 十二、核心技术

| 技术 | 作用 | 比喻 |
|------|------|------|
| **Feign** | 远程调用 | 打电话的人 |
| **Nacos** | 服务注册与发现 | 通讯录 |
| **Spring Boot** | 应用框架 | 房子的框架 |
| **MyBatis** | 数据库操作 | 查数据库的工具 |
| **MySQL** | 数据库 | 存数据的地方 |

---

## 十三、数据库关系

### 订单表（cloud_order.tb_order）
```sql
CREATE TABLE tb_order (
  id BIGINT PRIMARY KEY,
  user_id BIGINT,      -- 关联用户ID
  name VARCHAR(100),
  price BIGINT,
  num INT
);
```

---

### 用户表（cloud_user.tb_user）
```sql
CREATE TABLE tb_user (
  id BIGINT PRIMARY KEY,
  username VARCHAR(100),
  address VARCHAR(200)
);
```

---

### 关联关系
```
tb_order.user_id → tb_user.id
```

**说明：** 订单表只存用户ID，不存用户名和地址，需要时去用户服务查。

---

## 十四、常见问题

### 1. 为啥 IP 是 192.168.26.1？

**答：** 你电脑的 IP，自动获取的。

---

### 2. 为啥端口是 8080 和 8081？

**答：** `application.yml` 里配置的。

---

### 3. 为啥要用 Feign？

**答：** 让远程调用像调本地方法一样简单。

---

### 4. 为啥要用 Nacos？

**答：** 自动管理服务地址，不用写死 IP。

---

### 5. 调用失败怎么办？

**答：** UserService 挂了会报错，可以加熔断降级（Sentinel），返回默认值。

---

### 6. 性能会不会慢？

**答：** 多了一次网络调用，慢几毫秒，但换来了解耦和可扩展性。

---

## 十五、总结（最简单版）

### 三句话说清楚

1. **OrderService 查订单**：查到订单 101，发现是用户 1 下的
2. **调用 UserService**：通过 Feign 问 Nacos 要地址，然后调用 UserService 查用户 1
3. **返回完整数据**：把订单 + 用户信息拼起来返回

---

### 关键点

- **OrderService 端口**：8080
- **UserService 端口**：8081
- **Nacos 端口**：8848
- **IP 地址**：192.168.26.1（你电脑的 IP）
- **调用关系**：OrderService → Feign → Nacos → UserService

---

### 一张图看懂

```
你
 ↓
OrderService (8080)
 ↓
查订单表 → 得到订单，但没用户信息
 ↓
调用 UserService
 ↓
Feign 问 Nacos："userservice 在哪？"
 ↓
Nacos 回答："192.168.26.1:8081"
 ↓
Feign 发请求 → UserService (8081)
 ↓
查用户表 → 得到用户信息
 ↓
返回给 OrderService
 ↓
拼装：订单 + 用户
 ↓
返回给你
```

---

## 十六、相关文件

- OrderController: `order-service/src/main/java/cn/itcast/order/web/OrderController.java`
- OrderService: `order-service/src/main/java/cn/itcast/order/service/OrderService.java`
- UserController: `user-service/src/main/java/cn/itcast/user/web/UserController.java`
- UserClient: `feign-api/src/main/java/cn/itcast/feign/clients/UserClient.java`
- OrderService 配置: `order-service/src/main/resources/application.yml`
- UserService 配置: `user-service/src/main/resources/application.yml`
- UserService 引导配置: `user-service/src/main/resources/bootstrap.yml`
